<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://oldcamel.run</id>
    <title>Old Camel</title>
    <updated>2021-06-01T07:54:25.220Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://oldcamel.run"/>
    <link rel="self" href="https://oldcamel.run/atom.xml"/>
    <subtitle>æ—¥å¸¸å¼€å‘è®°å½• 
&lt;div&gt;&lt;iframe frameborder=&quot;no&quot; border=&quot;0&quot; marginwidth=&quot;0&quot; marginheight=&quot;0&quot; width=330 height=86 src=&quot;//music.163.com/outchain/player?type=2&amp;id=18611643&amp;auto=1&amp;height=66&quot;&gt;&lt;/iframe&gt;&lt;/div&gt;</subtitle>
    <logo>https://oldcamel.run/images/avatar.png</logo>
    <icon>https://oldcamel.run/favicon.ico</icon>
    <rights>All rights reserved 2021, Old Camel</rights>
    <entry>
        <title type="html"><![CDATA[PostgreSql æ•°æ®ç±»å‹]]></title>
        <id>https://oldcamel.run/post/postgresql-shu-ju-lei-xing/</id>
        <link href="https://oldcamel.run/post/postgresql-shu-ju-lei-xing/">
        </link>
        <updated>2021-06-01T07:15:34.000Z</updated>
        <content type="html"><![CDATA[<h1 id="æ•°å€¼ç±»å‹">æ•°å€¼ç±»å‹</h1>
<p>æ•°å€¼ç±»å‹ç”± 2 å­—èŠ‚ã€4 å­—èŠ‚æˆ– 8 å­—èŠ‚çš„æ•´æ•°ä»¥åŠ 4 å­—èŠ‚æˆ– 8 å­—èŠ‚çš„æµ®ç‚¹æ•°å’Œå¯é€‰ç²¾åº¦çš„åè¿›åˆ¶æ•°ç»„æˆã€‚</p>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>å­˜å‚¨é•¿åº¦</th>
<th>æè¿°</th>
<th>èŒƒå›´</th>
</tr>
</thead>
<tbody>
<tr>
<td>smallint</td>
<td>2 å­—èŠ‚</td>
<td>å°èŒƒå›´æ•´æ•°</td>
<td>-32768 åˆ° +32767</td>
</tr>
<tr>
<td>integer</td>
<td>4 å­—èŠ‚</td>
<td>å¸¸ç”¨çš„æ•´æ•°</td>
<td>-2147483648 åˆ° +2147483647</td>
</tr>
<tr>
<td>bigint</td>
<td>8 å­—èŠ‚</td>
<td>å¤§èŒƒå›´æ•´æ•°</td>
<td>-9223372036854775808 åˆ° +9223372036854775807</td>
</tr>
<tr>
<td>decimal</td>
<td>å¯å˜é•¿</td>
<td>ç”¨æˆ·æŒ‡å®šçš„ç²¾åº¦ï¼Œç²¾ç¡®</td>
<td>å°æ•°ç‚¹å‰ 131072 ä½ï¼›å°æ•°ç‚¹å 16383 ä½</td>
</tr>
<tr>
<td>numeric</td>
<td>å¯å˜é•¿</td>
<td>ç”¨æˆ·æŒ‡å®šçš„ç²¾åº¦ï¼Œç²¾ç¡®</td>
<td>å°æ•°ç‚¹å‰ 131072 ä½ï¼›å°æ•°ç‚¹å 16383 ä½</td>
</tr>
<tr>
<td>real</td>
<td>4 å­—èŠ‚</td>
<td>å¯å˜ç²¾åº¦ï¼Œä¸ç²¾ç¡®</td>
<td>6 ä½åè¿›åˆ¶æ•°å­—ç²¾åº¦</td>
</tr>
<tr>
<td>double precision</td>
<td>8 å­—èŠ‚</td>
<td>å¯å˜ç²¾åº¦ï¼Œä¸ç²¾ç¡®</td>
<td>15 ä½åè¿›åˆ¶æ•°å­—ç²¾åº¦</td>
</tr>
<tr>
<td>smallserial</td>
<td>2 å­—èŠ‚</td>
<td>è‡ªå¢çš„å°èŒƒå›´æ•´æ•°</td>
<td>1 åˆ° 32767</td>
</tr>
<tr>
<td>serial</td>
<td>4 å­—èŠ‚</td>
<td>è‡ªå¢æ•´æ•°</td>
<td>1 åˆ° 2147483647</td>
</tr>
<tr>
<td>bigserial</td>
<td>8 å­—èŠ‚</td>
<td>è‡ªå¢çš„å¤§èŒƒå›´æ•´æ•°</td>
<td>1 åˆ° 9223372036854775807</td>
</tr>
</tbody>
</table>
<h1 id="è´§å¸ç±»å‹">è´§å¸ç±»å‹</h1>
<p>money ç±»å‹å­˜å‚¨å¸¦æœ‰å›ºå®šå°æ•°ç²¾åº¦çš„è´§å¸é‡‘é¢ã€‚<br>
numericã€int å’Œ bigint ç±»å‹çš„å€¼å¯ä»¥è½¬æ¢ä¸º moneyï¼Œä¸å»ºè®®ä½¿ç”¨æµ®ç‚¹æ•°æ¥å¤„ç†å¤„ç†è´§å¸ç±»å‹ï¼Œå› ä¸ºå­˜åœ¨èˆå…¥é”™è¯¯çš„å¯èƒ½æ€§ã€‚</p>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>å­˜å‚¨é•¿åº¦</th>
<th>æè¿°</th>
<th>èŒƒå›´</th>
</tr>
</thead>
<tbody>
<tr>
<td>money</td>
<td>8å­—èŠ‚</td>
<td>è´§å¸é‡‘é¢</td>
<td>-92233720368547758.08 åˆ° +92233720368547758.07</td>
</tr>
</tbody>
</table>
<h1 id="å­—ç¬¦ç±»å‹">å­—ç¬¦ç±»å‹</h1>
<table>
<thead>
<tr>
<th>åºå·</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>character varying(n), varchar(n)å˜é•¿ï¼Œæœ‰é•¿åº¦é™åˆ¶</td>
</tr>
<tr>
<td>2</td>
<td>character(n), char(n) å®šé•¿,ä¸è¶³è¡¥ç©ºç™½</td>
</tr>
<tr>
<td>3</td>
<td>text  å˜é•¿ï¼Œæ— é•¿åº¦é™åˆ¶</td>
</tr>
</tbody>
</table>
<h1 id="æ—¥æœŸæ—¶é—´ç±»å‹">æ—¥æœŸ/æ—¶é—´ç±»å‹</h1>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>å­˜å‚¨ç©ºé—´</th>
<th>æè¿°</th>
<th>æœ€ä½å€¼</th>
<th>æœ€é«˜å€¼</th>
<th>åˆ†è¾¨ç‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>timestamp [ (p) ] [ without time zone ]</td>
<td>8 å­—èŠ‚</td>
<td>æ—¥æœŸå’Œæ—¶é—´(æ— æ—¶åŒº)</td>
<td>4713 BC</td>
<td>294276 AD</td>
<td>1 æ¯«ç§’ / 14 ä½</td>
</tr>
<tr>
<td>timestamp [ (p) ] with time zone</td>
<td>8 å­—èŠ‚</td>
<td>æ—¥æœŸå’Œæ—¶é—´ï¼Œæœ‰æ—¶åŒº</td>
<td>4713 BC</td>
<td>294276 AD</td>
<td>1 æ¯«ç§’ / 14 ä½</td>
</tr>
<tr>
<td>date</td>
<td>4 å­—èŠ‚</td>
<td>åªç”¨äºæ—¥æœŸ</td>
<td>4713 BC</td>
<td>5874897 AD</td>
<td>1 å¤©</td>
</tr>
<tr>
<td>time [ (p) ] [ without time zone ]</td>
<td>8 å­—èŠ‚</td>
<td>åªç”¨äºä¸€æ—¥å†…æ—¶é—´</td>
<td>00:00:00</td>
<td>24:00:00</td>
<td>1 æ¯«ç§’ / 14 ä½</td>
</tr>
<tr>
<td>time [ (p) ] with time zone</td>
<td>12 å­—èŠ‚</td>
<td>åªç”¨äºä¸€æ—¥å†…æ—¶é—´ï¼Œå¸¦æ—¶åŒº</td>
<td>00:00:00+1459</td>
<td>24:00:00-1459</td>
<td>1 æ¯«ç§’ / 14 ä½</td>
</tr>
<tr>
<td>interval [ fields ] [ (p) ]</td>
<td>12 å­—èŠ‚</td>
<td>æ—¶é—´é—´éš”</td>
<td>-178000000 å¹´</td>
<td>178000000 å¹´</td>
<td>1 æ¯«ç§’ / 14 ä½</td>
</tr>
</tbody>
</table>
<h1 id="å¸ƒå°”ç±»å‹">å¸ƒå°”ç±»å‹</h1>
<p>PostgreSQL æ”¯æŒæ ‡å‡†çš„ boolean æ•°æ®ç±»å‹ã€‚</p>
<p>boolean æœ‰&quot;true&quot;(çœŸ)æˆ–&quot;false&quot;(å‡)ä¸¤ä¸ªçŠ¶æ€ï¼Œ ç¬¬ä¸‰ç§&quot;unknown&quot;(æœªçŸ¥)çŠ¶æ€ï¼Œç”¨ NULL è¡¨ç¤ºã€‚</p>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>å­˜å‚¨æ ¼å¼</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>boolean</td>
<td>1 å­—èŠ‚</td>
<td>true/false</td>
</tr>
</tbody>
</table>
<h1 id="æšä¸¾ç±»å‹">æšä¸¾ç±»å‹</h1>
<p>æšä¸¾ç±»å‹æ˜¯ä¸€ä¸ªåŒ…å«é™æ€å’Œå€¼çš„æœ‰åºé›†åˆçš„æ•°æ®ç±»å‹ã€‚</p>
<p>PostgtesSQLä¸­çš„æšä¸¾ç±»å‹ç±»ä¼¼äº C è¯­è¨€ä¸­çš„ enum ç±»å‹ã€‚</p>
<p>ä¸å…¶ä»–ç±»å‹ä¸åŒçš„æ˜¯æšä¸¾ç±»å‹éœ€è¦ä½¿ç”¨ CREATE TYPE å‘½ä»¤åˆ›å»ºã€‚</p>
<p><code>CREATE TYPE mood AS ENUM ('sad', 'ok', 'happy');</code><br>
åˆ›å»ºä¸€å‘¨ä¸­çš„å‡ å¤©ï¼Œå¦‚ä¸‹æ‰€ç¤º:<br>
<code>CREATE TYPE week AS ENUM ('Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun');</code><br>
å°±åƒå…¶ä»–ç±»å‹ä¸€æ ·ï¼Œä¸€æ—¦åˆ›å»ºï¼Œæšä¸¾ç±»å‹å¯ä»¥ç”¨äºè¡¨å’Œå‡½æ•°å®šä¹‰ã€‚</p>
<pre><code class="language-java">CREATE TYPE mood AS ENUM ('sad', 'ok', 'happy');
CREATE TABLE person (
    name text,
    current_mood mood
);
INSERT INTO person VALUES ('Moe', 'happy');
SELECT * FROM person WHERE current_mood = 'happy';
 name | current_mood 
------+--------------
 Moe  | happy
(1 row)
</code></pre>
<h1 id="å‡ ä½•ç±»å‹">å‡ ä½•ç±»å‹</h1>
<p>å‡ ä½•æ•°æ®ç±»å‹è¡¨ç¤ºäºŒç»´çš„å¹³é¢ç‰©ä½“ã€‚æœ€åŸºæœ¬çš„ç±»å‹ï¼šç‚¹ã€‚å®ƒæ˜¯å…¶å®ƒç±»å‹çš„åŸºç¡€ã€‚</p>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>å­˜å‚¨ç©ºé—´</th>
<th>è¯´æ˜</th>
<th>è¡¨ç°å½¢å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>point</td>
<td>16 å­—èŠ‚</td>
<td>å¹³é¢ä¸­çš„ç‚¹</td>
<td>(x,y)</td>
</tr>
<tr>
<td>line</td>
<td>32 å­—èŠ‚</td>
<td>(æ— ç©·)ç›´çº¿(æœªå®Œå…¨å®ç°)</td>
<td>((x1,y1),(x2,y2))</td>
</tr>
<tr>
<td>lseg</td>
<td>32 å­—èŠ‚</td>
<td>(æœ‰é™)çº¿æ®µ</td>
<td>((x1,y1),(x2,y2))</td>
</tr>
<tr>
<td>box</td>
<td>32 å­—èŠ‚</td>
<td>çŸ©å½¢</td>
<td>((x1,y1),(x2,y2))</td>
</tr>
<tr>
<td>path</td>
<td>16+16n å­—èŠ‚</td>
<td>é—­åˆè·¯å¾„(ä¸å¤šè¾¹å½¢ç±»ä¼¼)</td>
<td>((x1,y1),...)</td>
</tr>
<tr>
<td>path</td>
<td>16+16n å­—èŠ‚</td>
<td>å¼€æ”¾è·¯å¾„</td>
<td>[(x1,y1),...]</td>
</tr>
<tr>
<td>polygon</td>
<td>40+16n å­—èŠ‚</td>
<td>å¤šè¾¹å½¢(ä¸é—­åˆè·¯å¾„ç›¸ä¼¼)</td>
<td>((x1,y1),...)</td>
</tr>
<tr>
<td>circle</td>
<td>24 å­—èŠ‚</td>
<td>åœ†	&lt;(x,y),r&gt;</td>
<td>(åœ†å¿ƒå’ŒåŠå¾„)</td>
</tr>
</tbody>
</table>
<h1 id="ç½‘ç»œåœ°å€ç±»å‹">ç½‘ç»œåœ°å€ç±»å‹</h1>
<p>PostgreSQL æä¾›ç”¨äºå­˜å‚¨ IPv4 ã€IPv6 ã€MAC åœ°å€çš„æ•°æ®ç±»å‹ã€‚ç”¨è¿™äº›æ•°æ®ç±»å‹å­˜å‚¨ç½‘ç»œåœ°å€æ¯”ç”¨çº¯æ–‡æœ¬ç±»å‹å¥½ï¼Œ å› ä¸ºè¿™äº›ç±»å‹æä¾›è¾“å…¥é”™è¯¯æ£€æŸ¥å’Œç‰¹æ®Šçš„æ“ä½œå’ŒåŠŸèƒ½ã€‚</p>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>å­˜å‚¨ç©ºé—´</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>cidr</td>
<td>7 æˆ– 19 å­—èŠ‚</td>
<td>IPv4 æˆ– IPv6 ç½‘ç»œ</td>
</tr>
<tr>
<td>inet</td>
<td>7 æˆ– 19 å­—èŠ‚</td>
<td>IPv4 æˆ– IPv6 ä¸»æœºå’Œç½‘ç»œ</td>
</tr>
<tr>
<td>macaddr</td>
<td>6 å­—èŠ‚</td>
<td>MAC åœ°å€</td>
</tr>
</tbody>
</table>
<p>åœ¨å¯¹ inet æˆ– cidr æ•°æ®ç±»å‹è¿›è¡Œæ’åºçš„æ—¶å€™ï¼Œ IPv4 åœ°å€æ€»æ˜¯æ’åœ¨ IPv6 åœ°å€å‰é¢ï¼ŒåŒ…æ‹¬é‚£äº›å°è£…æˆ–è€…æ˜¯æ˜ å°„åœ¨ IPv6 åœ°å€é‡Œçš„ IPv4 åœ°å€ï¼Œ æ¯”å¦‚ ::10.2.3.4 æˆ– ::ffff:10.4.3.2ã€‚</p>
<h1 id="ä½ä¸²ç±»å‹">ä½ä¸²ç±»å‹</h1>
<p>ä½ä¸²å°±æ˜¯ä¸€ä¸² 1 å’Œ 0 çš„å­—ç¬¦ä¸²ã€‚å®ƒä»¬å¯ä»¥ç”¨äºå­˜å‚¨å’Œç›´è§‚åŒ–ä½æ©ç ã€‚ æˆ‘ä»¬æœ‰ä¸¤ç§ SQL ä½ç±»å‹ï¼šbit(n) å’Œbit varying(n)ï¼Œ è¿™é‡Œçš„næ˜¯ä¸€ä¸ªæ­£æ•´æ•°ã€‚</p>
<p>bit ç±»å‹çš„æ•°æ®å¿…é¡»å‡†ç¡®åŒ¹é…é•¿åº¦ nï¼Œ è¯•å›¾å­˜å‚¨çŸ­äº›æˆ–è€…é•¿ä¸€äº›çš„æ•°æ®éƒ½æ˜¯é”™è¯¯çš„ã€‚bit varying ç±»å‹æ•°æ®æ˜¯æœ€é•¿ n çš„å˜é•¿ç±»å‹ï¼›æ›´é•¿çš„ä¸²ä¼šè¢«æ‹’ç»ã€‚ å†™ä¸€ä¸ªæ²¡æœ‰é•¿åº¦çš„bit ç­‰æ•ˆäº bit(1)ï¼Œ æ²¡æœ‰é•¿åº¦çš„ bit varying æ„æ€æ˜¯æ²¡æœ‰é•¿åº¦é™åˆ¶ã€‚</p>
<h1 id="æ–‡æœ¬æœç´¢ç±»å‹">æ–‡æœ¬æœç´¢ç±»å‹</h1>
<p>å…¨æ–‡æ£€ç´¢å³é€šè¿‡è‡ªç„¶è¯­è¨€æ–‡æ¡£çš„é›†åˆæ¥æ‰¾åˆ°é‚£äº›åŒ¹é…ä¸€ä¸ªæŸ¥è¯¢çš„æ£€ç´¢ã€‚<br>
PostgreSQL æä¾›äº†ä¸¤ç§æ•°æ®ç±»å‹ç”¨äºæ”¯æŒå…¨æ–‡æ£€ç´¢ï¼š</p>
<table>
<thead>
<tr>
<th>åºå·</th>
<th>åå­— &amp; æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>tsvector tsvector çš„å€¼æ˜¯ä¸€ä¸ªæ— é‡å¤å€¼çš„ lexemes æ’åºåˆ—è¡¨ï¼Œ å³ä¸€äº›åŒä¸€ä¸ªè¯çš„ä¸åŒå˜ç§çš„æ ‡å‡†åŒ–ã€‚</td>
</tr>
</tbody>
</table>
<p>2|	tsquery tsquery å­˜å‚¨ç”¨äºæ£€ç´¢çš„è¯æ±‡ï¼Œå¹¶ä¸”ä½¿ç”¨å¸ƒå°”æ“ä½œç¬¦ &amp;(AND)ï¼Œ|(OR)å’Œ!(NOT) æ¥ç»„åˆå®ƒä»¬ï¼Œæ‹¬å·ç”¨æ¥å¼ºè°ƒæ“ä½œç¬¦çš„åˆ†ç»„ã€‚</p>
<h1 id="uuid-ç±»å‹">UUID ç±»å‹</h1>
<p>uuid æ•°æ®ç±»å‹ç”¨æ¥å­˜å‚¨ RFC 4122ï¼ŒISO/IEF 9834-8:2005 ä»¥åŠç›¸å…³æ ‡å‡†å®šä¹‰çš„é€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰ã€‚ ï¼ˆä¸€äº›ç³»ç»Ÿè®¤ä¸ºè¿™ä¸ªæ•°æ®ç±»å‹ä¸ºå…¨çƒå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæˆ–GUIDã€‚ï¼‰ è¿™ä¸ªæ ‡è¯†ç¬¦æ˜¯ä¸€ä¸ªç”±ç®—æ³•äº§ç”Ÿçš„ 128 ä½æ ‡è¯†ç¬¦ï¼Œä½¿å®ƒä¸å¯èƒ½åœ¨å·²çŸ¥ä½¿ç”¨ç›¸åŒç®—æ³•çš„æ¨¡å—ä¸­å’Œå…¶ä»–æ–¹å¼äº§ç”Ÿçš„æ ‡è¯†ç¬¦ç›¸åŒã€‚ å› æ­¤ï¼Œå¯¹åˆ†å¸ƒå¼ç³»ç»Ÿè€Œè¨€ï¼Œè¿™ç§æ ‡è¯†ç¬¦æ¯”åºåˆ—èƒ½æ›´å¥½çš„æä¾›å”¯ä¸€æ€§ä¿è¯ï¼Œå› ä¸ºåºåˆ—åªèƒ½åœ¨å•ä¸€æ•°æ®åº“ä¸­ä¿è¯å”¯ä¸€ã€‚</p>
<p>UUID è¢«å†™æˆä¸€ä¸ªå°å†™åå…­è¿›åˆ¶æ•°å­—çš„åºåˆ—ï¼Œç”±åˆ†å­—ç¬¦åˆ†æˆå‡ ç»„ï¼Œ ç‰¹åˆ«æ˜¯ä¸€ç»„8ä½æ•°å­—+3ç»„4ä½æ•°å­—+ä¸€ç»„12ä½æ•°å­—ï¼Œæ€»å…± 32 ä¸ªæ•°å­—ä»£è¡¨ 128 ä½ï¼Œ ä¸€ä¸ªè¿™ç§æ ‡å‡†çš„ UUID ä¾‹å­å¦‚ä¸‹ï¼š<br>
<code>a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11</code></p>
<h1 id="xml-ç±»å‹">XML ç±»å‹</h1>
<p>xml æ•°æ®ç±»å‹å¯ä»¥ç”¨äºå­˜å‚¨XMLæ•°æ®ã€‚ å°† XML æ•°æ®å­˜åˆ° text ç±»å‹ä¸­çš„ä¼˜åŠ¿åœ¨äºå®ƒèƒ½å¤Ÿä¸ºç»“æ„è‰¯å¥½æ€§æ¥æ£€æŸ¥è¾“å…¥å€¼ï¼Œ å¹¶ä¸”è¿˜æ”¯æŒå‡½æ•°å¯¹å…¶è¿›è¡Œç±»å‹å®‰å…¨æ€§æ£€æŸ¥ã€‚ è¦ä½¿ç”¨è¿™ä¸ªæ•°æ®ç±»å‹ï¼Œç¼–è¯‘æ—¶å¿…é¡»ä½¿ç”¨ configure --with-libxmlã€‚</p>
<p>xml å¯ä»¥å­˜å‚¨ç”±XMLæ ‡å‡†å®šä¹‰çš„æ ¼å¼è‰¯å¥½çš„&quot;æ–‡æ¡£&quot;ï¼Œ ä»¥åŠç”± XML æ ‡å‡†ä¸­çš„ XMLDecl? content å®šä¹‰çš„&quot;å†…å®¹&quot;ç‰‡æ®µï¼Œ å¤§è‡´ä¸Šï¼Œè¿™æ„å‘³ç€å†…å®¹ç‰‡æ®µå¯ä»¥æœ‰å¤šä¸ªé¡¶çº§å…ƒç´ æˆ–å­—ç¬¦èŠ‚ç‚¹ã€‚ xmlvalue IS DOCUMENT è¡¨è¾¾å¼å¯ä»¥ç”¨æ¥åˆ¤æ–­ä¸€ä¸ªç‰¹å®šçš„ xml å€¼æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶è¿˜æ˜¯å†…å®¹ç‰‡æ®µã€‚</p>
<h2 id="åˆ›å»ºxmlå€¼">åˆ›å»ºXMLå€¼</h2>
<p>ä½¿ç”¨å‡½æ•° xmlparse: æ¥ä»å­—ç¬¦æ•°æ®äº§ç”Ÿ xml ç±»å‹çš„å€¼ï¼š</p>
<pre><code>XMLPARSE (DOCUMENT '&lt;?xml version=&quot;1.0&quot;?&gt;&lt;book&gt;&lt;title&gt;Manual&lt;/title&gt;&lt;chapter&gt;...&lt;/chapter&gt;&lt;/book&gt;')
XMLPARSE (CONTENT 'abc&lt;foo&gt;bar&lt;/foo&gt;&lt;bar&gt;foo&lt;/bar&gt;')
</code></pre>
<h1 id="json-ç±»å‹">JSON ç±»å‹</h1>
<p>json æ•°æ®ç±»å‹å¯ä»¥ç”¨æ¥å­˜å‚¨ JSONï¼ˆJavaScript Object Notationï¼‰æ•°æ®ï¼Œ è¿™æ ·çš„æ•°æ®ä¹Ÿå¯ä»¥å­˜å‚¨ä¸º textï¼Œä½†æ˜¯ json æ•°æ®ç±»å‹æ›´æœ‰åˆ©äºæ£€æŸ¥æ¯ä¸ªå­˜å‚¨çš„æ•°å€¼æ˜¯å¯ç”¨çš„ JSON å€¼ã€‚</p>
<p>æ­¤å¤–è¿˜æœ‰ç›¸å…³çš„å‡½æ•°æ¥å¤„ç† json æ•°æ®ï¼š</p>
<table>
<thead>
<tr>
<th>å®ä¾‹</th>
<th>å®ä¾‹ç»“æœ</th>
</tr>
</thead>
<tbody>
<tr>
<td>array_to_json('{{1,5},{99,100}}'::int[])</td>
<td>[[1,5],[99,100]]</td>
</tr>
<tr>
<td>row_to_json(row(1,'foo'))</td>
<td>{&quot;f1&quot;:1,&quot;f2&quot;:&quot;foo&quot;}</td>
</tr>
</tbody>
</table>
<h1 id="æ•°ç»„ç±»å‹">æ•°ç»„ç±»å‹</h1>
<p>PostgreSQL å…è®¸å°†å­—æ®µå®šä¹‰æˆå˜é•¿çš„å¤šç»´æ•°ç»„ã€‚</p>
<p>æ•°ç»„ç±»å‹å¯ä»¥æ˜¯ä»»ä½•åŸºæœ¬ç±»å‹æˆ–ç”¨æˆ·å®šä¹‰ç±»å‹ï¼Œæšä¸¾ç±»å‹æˆ–å¤åˆç±»å‹ã€‚</p>
<h2 id="å£°æ˜æ•°ç»„">å£°æ˜æ•°ç»„</h2>
<p>åˆ›å»ºè¡¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å£°æ˜æ•°ç»„ï¼Œæ–¹å¼å¦‚ä¸‹ï¼š</p>
<pre><code>CREATE TABLE sal_emp (
    name            text,
    pay_by_quarter  integer[],
    schedule        text[][]
);
</code></pre>
<p>pay_by_quarter ä¸ºä¸€ç»´æ•´å‹æ•°ç»„ã€schedule ä¸ºäºŒç»´æ–‡æœ¬ç±»å‹æ•°ç»„ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ &quot;ARRAY&quot; å…³é”®å­—ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code>CREATE TABLE sal_emp (
   name text,
   pay_by_quarter integer ARRAY[4],
   schedule text[][]
);
</code></pre>
<h2 id="æ’å…¥å€¼">æ’å…¥å€¼</h2>
<p>æ’å…¥å€¼ä½¿ç”¨èŠ±æ‹¬å· {}ï¼Œå…ƒç´ åœ¨ {} ä½¿ç”¨é€—å·éš”å¼€ï¼š</p>
<pre><code>INSERT INTO sal_emp
    VALUES ('Bill',
    '{10000, 10000, 10000, 10000}',
    '{{&quot;meeting&quot;, &quot;lunch&quot;}, {&quot;training&quot;, &quot;presentation&quot;}}');

INSERT INTO sal_emp
    VALUES ('Carol',
    '{20000, 25000, 25000, 25000}',
    '{{&quot;breakfast&quot;, &quot;consulting&quot;}, {&quot;meeting&quot;, &quot;lunch&quot;}}');
</code></pre>
<h2 id="è®¿é—®æ•°ç»„">è®¿é—®æ•°ç»„</h2>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªè¡¨ä¸Šè¿è¡Œä¸€äº›æŸ¥è¯¢ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¼”ç¤ºå¦‚ä½•è®¿é—®æ•°ç»„çš„ä¸€ä¸ªå…ƒç´ ã€‚ è¿™ä¸ªæŸ¥è¯¢æ£€ç´¢åœ¨ç¬¬äºŒå­£åº¦è–ªæ°´å˜åŒ–çš„é›‡å‘˜åï¼š</p>
<pre><code>SELECT name FROM sal_emp WHERE pay_by_quarter[1] &lt;&gt; pay_by_quarter[2];

 name
-------
 Carol
(1 row)
</code></pre>
<p>æ•°ç»„çš„ä¸‹æ ‡æ•°å­—æ˜¯å†™åœ¨æ–¹æ‹¬å¼§å†…çš„ã€‚</p>
<h2 id="ä¿®æ”¹æ•°ç»„">ä¿®æ”¹æ•°ç»„</h2>
<p>æˆ‘ä»¬å¯ä»¥å¯¹æ•°ç»„çš„å€¼è¿›è¡Œä¿®æ”¹ï¼š</p>
<p><code>UPDATE sal_emp SET pay_by_quarter = '{25000,25000,27000,27000}' WHERE name = 'Carol';</code><br>
æˆ–è€…ä½¿ç”¨ ARRAY æ„é€ å™¨è¯­æ³•ï¼š<br>
<code>UPDATE sal_emp SET pay_by_quarter = ARRAY[25000,25000,27000,27000] WHERE name = 'Carol';</code></p>
<h2 id="æ•°ç»„ä¸­æ£€ç´¢">æ•°ç»„ä¸­æ£€ç´¢</h2>
<p>è¦æœç´¢ä¸€ä¸ªæ•°ç»„ä¸­çš„æ•°å€¼ï¼Œä½ å¿…é¡»æ£€æŸ¥è¯¥æ•°ç»„çš„æ¯ä¸€ä¸ªå€¼ã€‚</p>
<p>æ¯”å¦‚ï¼š</p>
<pre><code>SELECT * FROM sal_emp WHERE pay_by_quarter[1] = 10000 OR
                            pay_by_quarter[2] = 10000 OR
                            pay_by_quarter[3] = 10000 OR
                            pay_by_quarter[4] = 10000;
</code></pre>
<p>å¦å¤–ï¼Œä½ å¯ä»¥ç”¨ä¸‹é¢çš„è¯­å¥æ‰¾å‡ºæ•°ç»„ä¸­æ‰€æœ‰å…ƒç´ å€¼éƒ½ç­‰äº 10000 çš„è¡Œï¼š</p>
<pre><code>SELECT * FROM sal_emp WHERE 10000 = ALL (pay_by_quarter);
</code></pre>
<p>æˆ–è€…ï¼Œå¯ä»¥ä½¿ç”¨ generate_subscripts å‡½æ•°ã€‚ä¾‹å¦‚ï¼š</p>
<pre><code>SELECT * FROM
   (SELECT pay_by_quarter,
           generate_subscripts(pay_by_quarter, 1) AS s
      FROM sal_emp) AS foo
 WHERE pay_by_quarter[s] = 10000;
</code></pre>
<h1 id="å¤åˆç±»å‹">å¤åˆç±»å‹</h1>
<p>å¤åˆç±»å‹è¡¨ç¤ºä¸€è¡Œæˆ–è€…ä¸€æ¡è®°å½•çš„ç»“æ„ï¼› å®ƒå®é™…ä¸Šåªæ˜¯ä¸€ä¸ªå­—æ®µåå’Œå®ƒä»¬çš„æ•°æ®ç±»å‹çš„åˆ—è¡¨ã€‚PostgreSQL å…è®¸åƒç®€å•æ•°æ®ç±»å‹é‚£æ ·ä½¿ç”¨å¤åˆç±»å‹ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªè¡¨çš„æŸä¸ªå­—æ®µå¯ä»¥å£°æ˜ä¸ºä¸€ä¸ªå¤åˆç±»å‹ã€‚</p>
<h2 id="å£°æ˜å¤åˆç±»å‹">å£°æ˜å¤åˆç±»å‹</h2>
<p>ä¸‹é¢æ˜¯ä¸¤ä¸ªå®šä¹‰å¤åˆç±»å‹çš„ç®€å•ä¾‹å­ï¼š</p>
<pre><code>CREATE TYPE complex AS (
   r       double precision,
   i       double precision
);

CREATE TYPE inventory_item AS (
   name            text,
   supplier_id     integer,
   price           numeric
);
</code></pre>
<p>è¯­æ³•ç±»ä¼¼äº CREATE TABLEï¼Œåªæ˜¯è¿™é‡Œåªå¯ä»¥å£°æ˜å­—æ®µåå­—å’Œç±»å‹ã€‚</p>
<p>å®šä¹‰äº†ç±»å‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨å®ƒåˆ›å»ºè¡¨ï¼š</p>
<pre><code>CREATE TABLE on_hand (
   item      inventory_item,
   count     integer
);

INSERT INTO on_hand VALUES (ROW('fuzzy dice', 42, 1.99), 1000);
</code></pre>
<h2 id="å¤åˆç±»å‹å€¼è¾“å…¥">å¤åˆç±»å‹å€¼è¾“å…¥</h2>
<p>è¦ä»¥æ–‡æœ¬å¸¸é‡ä¹¦å†™å¤åˆç±»å‹å€¼ï¼Œåœ¨åœ†æ‹¬å¼§é‡ŒåŒ…å›´å­—æ®µå€¼å¹¶ä¸”ç”¨é€—å·åˆ†éš”ä»–ä»¬ã€‚ ä½ å¯ä»¥åœ¨ä»»ä½•å­—æ®µå€¼å‘¨å›´æ”¾ä¸ŠåŒå¼•å·ï¼Œå¦‚æœå€¼æœ¬èº«åŒ…å«é€—å·æˆ–è€…åœ†æ‹¬å¼§ï¼Œ ä½ å¿…é¡»ç”¨åŒå¼•å·æ‹¬èµ·ã€‚</p>
<p>å¤åˆç±»å‹å¸¸é‡çš„ä¸€èˆ¬æ ¼å¼å¦‚ä¸‹ï¼š</p>
<p><code>'( val1 , val2 , ... )'</code><br>
ä¸€ä¸ªä¾‹å­æ˜¯:<br>
<code>'(&quot;fuzzy dice&quot;,42,1.99)'</code></p>
<h2 id="è®¿é—®å¤åˆç±»å‹">è®¿é—®å¤åˆç±»å‹</h2>
<p>è¦è®¿é—®å¤åˆç±»å‹å­—æ®µçš„ä¸€ä¸ªåŸŸï¼Œæˆ‘ä»¬å†™å‡ºä¸€ä¸ªç‚¹ä»¥åŠåŸŸçš„åå­—ï¼Œ éå¸¸ç±»ä¼¼ä»ä¸€ä¸ªè¡¨åå­—é‡Œé€‰å‡ºä¸€ä¸ªå­—æ®µã€‚å®é™…ä¸Šï¼Œå› ä¸ºå®åœ¨å¤ªåƒä»è¡¨åå­—ä¸­é€‰å–å­—æ®µï¼Œ æ‰€ä»¥æˆ‘ä»¬ç»å¸¸éœ€è¦ç”¨åœ†æ‹¬å¼§æ¥é¿å…åˆ†æå™¨æ··æ·†ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½éœ€è¦ä»on_hand ä¾‹å­è¡¨ä¸­é€‰å–ä¸€äº›å­åŸŸï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p>
<pre><code>SELECT item.name FROM on_hand WHERE item.price &gt; 9.99;
</code></pre>
<p>è¿™æ ·å°†ä¸èƒ½å·¥ä½œï¼Œå› ä¸ºæ ¹æ® SQL è¯­æ³•ï¼Œitemæ˜¯ä»ä¸€ä¸ªè¡¨åå­—é€‰å–çš„ï¼Œ è€Œä¸æ˜¯ä¸€ä¸ªå­—æ®µåå­—ã€‚ä½ å¿…é¡»åƒä¸‹é¢è¿™æ ·å†™ï¼š</p>
<pre><code>SELECT (item).name FROM on_hand WHERE (item).price &gt; 9.99;
</code></pre>
<p>æˆ–è€…å¦‚æœä½ ä¹Ÿéœ€è¦ä½¿ç”¨è¡¨åå­—(æ¯”å¦‚ï¼Œåœ¨ä¸€ä¸ªå¤šè¡¨æŸ¥è¯¢é‡Œ)ï¼Œé‚£ä¹ˆè¿™ä¹ˆå†™ï¼š</p>
<pre><code>SELECT (on_hand.item).name FROM on_hand WHERE (on_hand.item).price &gt; 9.99;
</code></pre>
<p>ç°åœ¨åœ†æ‹¬å¼§å¯¹è±¡æ­£ç¡®åœ°è§£æä¸ºä¸€ä¸ªæŒ‡å‘itemå­—æ®µçš„å¼•ç”¨ï¼Œç„¶åå°±å¯ä»¥ä»ä¸­é€‰å–å­åŸŸã€‚</p>
<h1 id="èŒƒå›´ç±»å‹">èŒƒå›´ç±»å‹</h1>
<p>èŒƒå›´æ•°æ®ç±»å‹ä»£è¡¨ç€æŸä¸€å…ƒç´ ç±»å‹åœ¨ä¸€å®šèŒƒå›´å†…çš„å€¼ã€‚</p>
<p>ä¾‹å¦‚ï¼Œtimestamp èŒƒå›´å¯èƒ½è¢«ç”¨äºä»£è¡¨ä¸€é—´ä¼šè®®å®¤è¢«é¢„å®šçš„æ—¶é—´èŒƒå›´ã€‚</p>
<p>PostgreSQL å†…ç½®çš„èŒƒå›´ç±»å‹æœ‰ï¼š</p>
<ul>
<li>int4range â€” integerçš„èŒƒå›´</li>
<li>int8range â€”bigintçš„èŒƒå›´</li>
<li>numrange â€”numericçš„èŒƒå›´</li>
<li>tsrange â€”timestamp without time zoneçš„èŒƒå›´</li>
<li>tstzrange â€”timestamp with time zoneçš„èŒƒå›´</li>
<li>daterange â€”dateçš„èŒƒå›´<br>
æ­¤å¤–ï¼Œä½ å¯ä»¥å®šä¹‰ä½ è‡ªå·±çš„èŒƒå›´ç±»å‹ã€‚</li>
</ul>
<pre><code>CREATE TABLE reservation (room int, during tsrange);
INSERT INTO reservation VALUES
    (1108, '[2010-01-01 14:30, 2010-01-01 15:30)');

-- åŒ…å«
SELECT int4range(10, 20) @&gt; 3;

-- é‡å 
SELECT numrange(11.1, 22.2) &amp;&amp; numrange(20.0, 30.0);

-- æå–ä¸Šè¾¹ç•Œ
SELECT upper(int8range(15, 25));

-- è®¡ç®—äº¤å‰
SELECT int4range(10, 20) * int4range(15, 25);

-- èŒƒå›´æ˜¯å¦ä¸ºç©º
SELECT isempty(numrange(1, 5));
</code></pre>
<p>èŒƒå›´å€¼çš„è¾“å…¥å¿…é¡»éµå¾ªä¸‹é¢çš„æ ¼å¼ï¼š</p>
<pre><code>(ä¸‹è¾¹ç•Œ,ä¸Šè¾¹ç•Œ)
(ä¸‹è¾¹ç•Œ,ä¸Šè¾¹ç•Œ]
[ä¸‹è¾¹ç•Œ,ä¸Šè¾¹ç•Œ)
[ä¸‹è¾¹ç•Œ,ä¸Šè¾¹ç•Œ]
ç©º
</code></pre>
<p>åœ†æ‹¬å·æˆ–è€…æ–¹æ‹¬å·æ˜¾ç¤ºä¸‹è¾¹ç•Œå’Œä¸Šè¾¹ç•Œæ˜¯ä¸åŒ…å«çš„è¿˜æ˜¯åŒ…å«çš„ã€‚æ³¨æ„æœ€åçš„æ ¼å¼æ˜¯ ç©ºï¼Œä»£è¡¨ç€ä¸€ä¸ªç©ºçš„èŒƒå›´ï¼ˆä¸€ä¸ªä¸å«æœ‰å€¼çš„èŒƒå›´ï¼‰ã€‚</p>
<pre><code>-- åŒ…æ‹¬3ï¼Œä¸åŒ…æ‹¬7ï¼Œå¹¶ä¸”åŒ…æ‹¬äºŒè€…ä¹‹é—´çš„æ‰€æœ‰ç‚¹
SELECT '[3,7)'::int4range;

-- ä¸åŒ…æ‹¬3å’Œ7ï¼Œä½†æ˜¯åŒ…æ‹¬äºŒè€…ä¹‹é—´æ‰€æœ‰ç‚¹
SELECT '(3,7)'::int4range;

-- åªåŒ…æ‹¬å•ä¸€å€¼4
SELECT '[4,4]'::int4range;

-- ä¸åŒ…æ‹¬ç‚¹ï¼ˆè¢«æ ‡å‡†åŒ–ä¸ºâ€˜ç©ºâ€™ï¼‰
SELECT '[4,4)'::int4range;
</code></pre>
<h1 id="å¯¹è±¡æ ‡è¯†ç¬¦ç±»å‹">å¯¹è±¡æ ‡è¯†ç¬¦ç±»å‹</h1>
<p>PostgreSQL åœ¨å†…éƒ¨ä½¿ç”¨å¯¹è±¡æ ‡è¯†ç¬¦(OID)ä½œä¸ºå„ç§ç³»ç»Ÿè¡¨çš„ä¸»é”®ã€‚</p>
<p>åŒæ—¶ï¼Œç³»ç»Ÿä¸ä¼šç»™ç”¨æˆ·åˆ›å»ºçš„è¡¨å¢åŠ ä¸€ä¸ª OID ç³»ç»Ÿå­—æ®µ(é™¤éåœ¨å»ºè¡¨æ—¶å£°æ˜äº†WITH OIDS æˆ–è€…é…ç½®å‚æ•°default_with_oidsè®¾ç½®ä¸ºå¼€å¯)ã€‚oid ç±»å‹ä»£è¡¨ä¸€ä¸ªå¯¹è±¡æ ‡è¯†ç¬¦ã€‚é™¤æ­¤ä»¥å¤– oid è¿˜æœ‰å‡ ä¸ªåˆ«åï¼šregproc, regprocedure, regoper, regoperator, regclass, regtype, regconfig, å’Œregdictionaryã€‚</p>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>å¼•ç”¨</th>
<th>æè¿°</th>
<th>æ•°å€¼ä¾‹å­</th>
</tr>
</thead>
<tbody>
<tr>
<td>oid</td>
<td>ä»»æ„</td>
<td>æ•°å­—åŒ–çš„å¯¹è±¡æ ‡è¯†ç¬¦</td>
<td>564182</td>
</tr>
<tr>
<td>regproc</td>
<td>pg_proc</td>
<td>å‡½æ•°åå­—</td>
<td>sum</td>
</tr>
<tr>
<td>regprocedure</td>
<td>pg_proc</td>
<td>å¸¦å‚æ•°ç±»å‹çš„å‡½æ•°</td>
<td>sum(int4)</td>
</tr>
<tr>
<td>regoper</td>
<td>pg_operator</td>
<td>æ“ä½œç¬¦å</td>
<td>+</td>
</tr>
<tr>
<td>regoperator</td>
<td>pg_operator</td>
<td>å¸¦å‚æ•°ç±»å‹çš„æ“ä½œç¬¦</td>
<td>*(integer,integer) æˆ– -(NONE,integer)</td>
</tr>
<tr>
<td>regclass</td>
<td>pg_class</td>
<td>å…³ç³»å</td>
<td>pg_type</td>
</tr>
<tr>
<td>regtype</td>
<td>pg_type</td>
<td>æ•°æ®ç±»å‹å</td>
<td>integer</td>
</tr>
<tr>
<td>regconfig</td>
<td>pg_ts_config</td>
<td>æ–‡æœ¬æœç´¢é…ç½®</td>
<td>english</td>
</tr>
<tr>
<td>regdictionary</td>
<td>pg_ts_dict</td>
<td>æ–‡æœ¬æœç´¢å­—å…¸</td>
<td>simple</td>
</tr>
</tbody>
</table>
<h1 id="ä¼ªç±»å‹">ä¼ªç±»å‹</h1>
<p>PostgreSQLç±»å‹ç³»ç»ŸåŒ…å«ä¸€ç³»åˆ—ç‰¹æ®Šç”¨é€”çš„æ¡ç›®ï¼Œ å®ƒä»¬æŒ‰ç…§ç±»åˆ«æ¥è¯´å«åšä¼ªç±»å‹ã€‚ä¼ªç±»å‹ä¸èƒ½ä½œä¸ºå­—æ®µçš„æ•°æ®ç±»å‹ï¼Œ ä½†æ˜¯å®ƒå¯ä»¥ç”¨äºå£°æ˜ä¸€ä¸ªå‡½æ•°çš„å‚æ•°æˆ–è€…ç»“æœç±»å‹ã€‚ ä¼ªç±»å‹åœ¨ä¸€ä¸ªå‡½æ•°ä¸åªæ˜¯ç®€å•åœ°æ¥å—å¹¶è¿”å›æŸç§SQL æ•°æ®ç±»å‹çš„æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚</p>
<table>
<thead>
<tr>
<th>åå­—</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td>any</td>
<td>è¡¨ç¤ºä¸€ä¸ªå‡½æ•°æ¥å—ä»»ä½•è¾“å…¥æ•°æ®ç±»å‹ã€‚</td>
</tr>
<tr>
<td>anyelement</td>
<td>è¡¨ç¤ºä¸€ä¸ªå‡½æ•°æ¥å—ä»»ä½•æ•°æ®ç±»å‹ã€‚</td>
</tr>
<tr>
<td>anyarray</td>
<td>è¡¨ç¤ºä¸€ä¸ªå‡½æ•°æ¥å—ä»»æ„æ•°ç»„æ•°æ®ç±»å‹ã€‚</td>
</tr>
<tr>
<td>anynonarray</td>
<td>è¡¨ç¤ºä¸€ä¸ªå‡½æ•°æ¥å—ä»»æ„éæ•°ç»„æ•°æ®ç±»å‹ã€‚</td>
</tr>
<tr>
<td>anyenum</td>
<td>è¡¨ç¤ºä¸€ä¸ªå‡½æ•°æ¥å—ä»»æ„æšä¸¾æ•°æ®ç±»å‹ã€‚</td>
</tr>
<tr>
<td>anyrange</td>
<td>è¡¨ç¤ºä¸€ä¸ªå‡½æ•°æ¥å—ä»»æ„èŒƒå›´æ•°æ®ç±»å‹ã€‚</td>
</tr>
<tr>
<td>cstring</td>
<td>è¡¨ç¤ºä¸€ä¸ªå‡½æ•°æ¥å—æˆ–è€…è¿”å›ä¸€ä¸ªç©ºç»“å°¾çš„ C å­—ç¬¦ä¸²ã€‚</td>
</tr>
<tr>
<td>internal</td>
<td>è¡¨ç¤ºä¸€ä¸ªå‡½æ•°æ¥å—æˆ–è€…è¿”å›ä¸€ç§æœåŠ¡å™¨å†…éƒ¨çš„æ•°æ®ç±»å‹ã€‚</td>
</tr>
<tr>
<td>language_handler</td>
<td>ä¸€ä¸ªè¿‡ç¨‹è¯­è¨€è°ƒç”¨å¤„ç†å™¨å£°æ˜ä¸ºè¿”å›language_handlerã€‚</td>
</tr>
<tr>
<td>fdw_handler</td>
<td>ä¸€ä¸ªå¤–éƒ¨æ•°æ®å°è£…å™¨å£°æ˜ä¸ºè¿”å›fdw_handlerã€‚</td>
</tr>
<tr>
<td>record</td>
<td>æ ‡è¯†ä¸€ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªæœªå£°æ˜çš„è¡Œç±»å‹ã€‚</td>
</tr>
<tr>
<td>trigger</td>
<td>ä¸€ä¸ªè§¦å‘å™¨å‡½æ•°å£°æ˜ä¸ºè¿”å›triggerã€‚</td>
</tr>
<tr>
<td>void</td>
<td>è¡¨ç¤ºä¸€ä¸ªå‡½æ•°ä¸è¿”å›æ•°å€¼ã€‚</td>
</tr>
<tr>
<td>opaque</td>
<td>ä¸€ä¸ªå·²ç»è¿‡æ—¶çš„ç±»å‹ï¼Œä»¥å‰ç”¨äºæ‰€æœ‰ä¸Šé¢è¿™äº›ç”¨é€”ã€‚</td>
</tr>
</tbody>
</table>
<p>è½¬è½½åœ°å€ï¼šhttps://m.runoob.com/postgresql/postgresql-data-type.html</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[4.0 æ–°çš„å¼€ç«¯]]></title>
        <id>https://oldcamel.run/post/40-xin-de-kai-duan/</id>
        <link href="https://oldcamel.run/post/40-xin-de-kai-duan/">
        </link>
        <updated>2021-05-31T08:22:46.000Z</updated>
        <content type="html"><![CDATA[<p>åˆåˆåˆåˆå¼€å§‹æ­å»ºæ–°æ¡†æ¶äº†,è¿™æ¬¡å¼€æå¤šç§Ÿæˆ·äº‘æœåŠ¡ã€‚</p>
<table>
<thead>
<tr>
<th>åˆæ­¥è®¡åˆ’åˆ—è¡¨</th>
<th>å®Œæˆæƒ…å†µ</th>
</tr>
</thead>
<tbody>
<tr>
<td>mars-spring-boot-starter  å¤šæ•°æ®æº  jpa+mybatis</td>
<td>â˜‘ï¸</td>
</tr>
<tr>
<td>mars-spring-boot-starter  mybatis æ¢æˆmybatisplus</td>
<td>â˜‘ï¸</td>
</tr>
<tr>
<td>mars-spring-boot-starter  liquibaseåˆæ­¥é›†æˆï¼ˆå¤šæ•°æ®æºåœ¨å¯åŠ¨æ—¶åˆ·æ–°åº“ï¼‰</td>
<td>â˜‘ï¸</td>
</tr>
<tr>
<td>è®¤è¯ä¸­å¿ƒ å‡çº§ 2.5.0  spring-cloud-oauth2æ¢æˆ spring-security  oauth2</td>
<td></td>
</tr>
<tr>
<td>è®¤è¯ä¸­å¿ƒ jpaåœ¨pgsqlé‡Œè¿è¡Œ, è°ƒè¯•åŠŸèƒ½</td>
<td></td>
</tr>
<tr>
<td>mars-spring-boot-starter  æ·»åŠ é€šç”¨è®¾ç½®+å·¥å…·ç±»+pomä¾èµ–ï¼ˆä¾èµ–é¡¹ç›®pomç²¾ç®€ï¼‰</td>
<td></td>
</tr>
<tr>
<td>mars-archetype mavenæ¨¡æ¿é¡¹ç›®é‡æ–°ä¿®æ”¹</td>
<td></td>
</tr>
<tr>
<td>k8s rookå®‰è£…cephfsï¼Œæµ‹è¯•pvcåŠ¨æ€åŠ¨æ€æŒ‚è½½ï¼Œs3å‚¨å­˜</td>
<td></td>
</tr>
<tr>
<td>pgsql helmç‰ˆæœ¬</td>
<td></td>
</tr>
<tr>
<td>åŸºäºmasteræ•°æ®æºåšç§Ÿæˆ·ç®¡ç†åŠŸèƒ½ã€‚ç§Ÿæˆ·æ•°æ®è°ƒæ•´-&gt;åŠ¨æ€å¢å‡æ•°æ®æº-&gt;liquibaseåˆå§‹åŒ–åº“ï¼ˆå‘å¸ƒè®¢é˜…ï¼‰</td>
<td></td>
</tr>
<tr>
<td>æ–‡ä»¶ä¸­å¿ƒ mongoå­˜å‚¨ä¿®æ”¹ä¸º cephfså­˜å‚¨ ï¼ˆminioï¼‰</td>
<td></td>
</tr>
<tr>
<td>æ¶ˆæ¯ä¸­å¿ƒç­‰å…¶ä»–åŸºç¡€ç»„ä»¶ä¿®æ”¹</td>
<td></td>
</tr>
<tr>
<td>cephfs å¤‡ä»½è„šæœ¬</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="mars-spring-boot-starter-å¤šæ•°æ®æº-jpamybatis">mars-spring-boot-starter  å¤šæ•°æ®æº  jpa+mybatis</h2>
<p>å¤šç§Ÿæˆ·ç³»ç»Ÿ,æ•°æ®åº“æŒ‰ç§Ÿæˆ·åŒºåˆ†æ•°æ®æºã€‚è®¡åˆ’æ¯ä¸ªç§Ÿæˆ·å•ç‹¬æ•°æ®æºéƒ¨ç½²ï¼Œæ‰€ä»¥å…ˆæä¸ªå¯åŠ¨å™¨é…ç½®å¤šæ•°æ®æºã€‚<br>
å¤šæ•°æ®æºå®ç°:ç»§æ‰¿AbstractRoutingDataSourceï¼Œé‡å†™determineCurrentLookupKeyæ–¹æ³• è¿”å›è‡ªå®šä¹‰çš„keyã€‚è¿™ä¸ªkey ç”¨æ‹¦æˆªå™¨åœ¨è¯·æ±‚å¤´é‡Œè·å–ç”¨æˆ·çš„ç§Ÿæˆ·å€¼æ”¾åˆ°ä¸€ä¸ªçº¿ç¨‹å˜é‡é‡Œã€‚</p>
<ul>
<li>æ‹¦æˆªå™¨</li>
</ul>
<pre><code class="language-java">public class TenantInterceptor implements HandlerInterceptor {
    final String X_TENANT_ID = &quot;X_TenantID&quot;;
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        final String tenantId = request.getHeader(X_TENANT_ID);
        if (tenantId != null) {
            DynamicDataSourceContextHolder.setDataSourceKey(tenantId);
        }
        return true;
    }

    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        DynamicDataSourceContextHolder.clearDataSourceKey();
    }
}

@Configuration
public class TenantConfig implements WebMvcConfigurer {
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        //æŒ‡å®šæ‹¦æˆªå™¨ï¼ŒæŒ‡å®šæ‹¦æˆªè·¯å¾„
        registry.addInterceptor(new TenantInterceptor()).addPathPatterns(&quot;/**&quot;);
    }
}

</code></pre>
<ul>
<li>çº¿ç¨‹å˜é‡</li>
</ul>
<pre><code class="language-java">public class DynamicDataSourceContextHolder {
  private static final ThreadLocal&lt;String&gt; contextHolder = new ThreadLocal&lt;String&gt;() {
      /**
       * å°† master æ•°æ®æºçš„ keyä½œä¸ºé»˜è®¤æ•°æ®æºçš„ key
       */
      @Override
      protected String initialValue() {
          return &quot;master&quot;;
      }
  };

  /**
   * æ•°æ®æºçš„ keyé›†åˆï¼Œç”¨äºåˆ‡æ¢æ—¶åˆ¤æ–­æ•°æ®æºæ˜¯å¦å­˜åœ¨
   */
  public static Set&lt;Object&gt; dataSourceKeys = new HashSet&lt;&gt;();

  /**
   * åˆ‡æ¢æ•°æ®æº
   * @param key  æ•°æ®æº
   */
  public static void setDataSourceKey(String key) {
      if (StringUtils.isNotBlank(key)) {
          contextHolder.set(key);
      }
  }

  /**
   * è·å–æ•°æ®æº
   * @return
   */
  public static String getDataSourceKey() {
      return contextHolder.get();
  }

  /**
   * é‡ç½®æ•°æ®æº
   */
  public static void clearDataSourceKey() {
      contextHolder.remove();
  }

  /**
   * åˆ¤æ–­æ˜¯å¦åŒ…å«æ•°æ®æº
   * @param key   æ•°æ®æº
   * @return
   */
  public static boolean containDataSourceKey(String key) {
      return dataSourceKeys.contains(key);
  }

  /**
   * æ·»åŠ æ•°æ®æºKeys
   * @param keys
   * @return
   */
  public static boolean addDataSourceKeys(Collection&lt;? extends Object&gt; keys) {
      return dataSourceKeys.addAll(keys);
  }
}
</code></pre>
<ul>
<li>é…ç½®æ•°æ®æº</li>
</ul>
<pre><code class="language-java">
 @Bean(&quot;master&quot;)
   @ConfigurationProperties(prefix = &quot;spring.datasource.hikari&quot;)
   public DataSource master(){
       HikariDataSource build = (HikariDataSource)DataSourceBuilder.create().build();
       build.setTransactionIsolation(&quot;TRANSACTION_READ_COMMITTED&quot;);
       return build;
   }
   @Bean
   @Primary
   public DataSource dataSource(){
       DynamicDataSource dynamicDataSource = new DynamicDataSource();
       HashMap&lt;Object, Object&gt; dataSourceMap = new HashMap&lt;&gt;();
       dataSourceMap.put(&quot;master&quot;,master());
       dynamicDataSource.setDefaultDataSource(master());
       dynamicDataSource.setDataSources(dataSourceMap);
       dynamicDataSource.afterPropertiesSet();
       return  dynamicDataSource;
   }

</code></pre>
<ul>
<li>å¤šæ•°æ®æºè¯»å–</li>
</ul>
<pre><code class="language-java">@Data
public class DynamicDataSource  extends AbstractRoutingDataSource {
  private final Map&lt;Object, Object&gt; tenantDataSources = new ConcurrentHashMap&lt;&gt;();

  @Override
  protected Object determineCurrentLookupKey() {
      return DynamicDataSourceContextHolder.getDataSourceKey();
  }


  public void setDefaultDataSource(Object defaultDataSource) {
      super.setDefaultTargetDataSource(defaultDataSource);
  }

  public void setDataSources(Map&lt;Object, Object&gt; dataSources) {
      tenantDataSources.putAll(dataSources);
      super.setTargetDataSources(tenantDataSources);
      super.afterPropertiesSet();
      DynamicDataSourceContextHolder.addDataSourceKeys(dataSources.keySet());
  }

}
</code></pre>
<ul>
<li>åˆ›å»ºç§Ÿæˆ·è¡¨</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://oldcamel.run/post-images/1622451428396.png" alt="" loading="lazy"></figure>
<ul>
<li>å†™ApplicationRunneråœ¨é¡¹ç›®å¯åŠ¨å®Œæˆåæ·»åŠ å¤šç§Ÿæˆ·æ•°æ®æº</li>
</ul>
<pre><code class="language-java">  public class DynamicDataSourceInit implements ApplicationRunner {
    @Autowired
    DynamicDataSource dataSource;
    @Override
    public void run(ApplicationArguments args) throws Exception {
        HikariDataSource hikariDataSource = (HikariDataSource) SpringContextUtils.getBean(&quot;master&quot;);
        Map&lt;Object, Object&gt; resolvedDataSources =new HashMap&lt;&gt;();
        Connection connection = hikariDataSource.getConnection();
        Statement statement = connection.createStatement();
        ResultSet resultSet = statement.executeQuery(&quot;select tenant_id   \&quot;tenantId\&quot;,tenant_name \&quot;tenantName\&quot;,datasource_url \&quot;datasourceUrl\&quot;,datasource_username \&quot;datasourceUsername\&quot;,datasource_password \&quot;datasourcePassword\&quot;,datasource_driver \&quot;datasourceDriver\&quot; from tenant where status=1&quot;);
        List&lt;Tenant&gt; tenants = (ArrayList&lt;Tenant&gt;) this.populate(resultSet, Tenant.class);
        for (Tenant tenant : tenants) {
            HikariDataSource dataSource = new HikariDataSource();
            dataSource.setDriverClassName(tenant.getDatasourceDriver());
            dataSource.setJdbcUrl(tenant.getDatasourceUrl());
            dataSource.setUsername(tenant.getDatasourceUsername());
            dataSource.setPassword(tenant.getDatasourcePassword());
            dataSource.setConnectionTestQuery(&quot;SELECT 1&quot;);
            dataSource.setTransactionIsolation(&quot;TRANSACTION_READ_COMMITTED&quot;);
            dataSource.setDataSourceProperties(hikariDataSource.getDataSourceProperties());
            resolvedDataSources.put(tenant.getTenantId(), dataSource);
        }
        dataSource.setDataSources(resolvedDataSources);
        dataSource.afterPropertiesSet();
        connection.close();
    }
    private    List populate(ResultSet rs , Class clazz) throws SQLException, InstantiationException, IllegalAccessException{
        //ç»“æœé›†çš„å…ƒç´ å¯¹è±¡
        ResultSetMetaData rsmd = rs.getMetaData();
        //è·å–ç»“æœé›†çš„å…ƒç´ ä¸ªæ•°
        int colCount = rsmd.getColumnCount();
        //è¿”å›ç»“æœçš„åˆ—è¡¨é›†åˆ
        List list = new ArrayList();
        //ä¸šåŠ¡å¯¹è±¡çš„å±æ€§æ•°ç»„
        Field[] fields = clazz.getDeclaredFields();
        while(rs.next()){//å¯¹æ¯ä¸€æ¡è®°å½•è¿›è¡Œæ“ä½œ
            Object obj = clazz.newInstance();//æ„é€ ä¸šåŠ¡å¯¹è±¡å®ä½“
            //å°†æ¯ä¸€ä¸ªå­—æ®µå–å‡ºè¿›è¡Œèµ‹å€¼
            for(int i = 1;i&lt;=colCount;i++){
                Object value = rs.getObject(i);
                //å¯»æ‰¾è¯¥åˆ—å¯¹åº”çš„å¯¹è±¡å±æ€§
                for(int j=0;j&lt;fields.length;j++){
                    Field f = fields[j];
                    //å¦‚æœåŒ¹é…è¿›è¡Œèµ‹å€¼
                    if(f.getName().equalsIgnoreCase(rsmd.getColumnName(i))){
                        boolean flag = f.isAccessible();
                        f.setAccessible(true);
                        f.set(obj, value);
                        f.setAccessible(flag);
                    }
                }
            }
            list.add(obj);
        }
        return list;
    }
}
</code></pre>
<h1 id="mars-spring-boot-starter-mybatis-æ¢æˆmybatisplus">mars-spring-boot-starter  mybatis æ¢æˆmybatisplus</h1>
<p>å› ä¸ºéƒ¨åˆ†é¡¹ç›®ç»„ç”¨äº†mybatisplus,åœ¨å¯åŠ¨å™¨é‡ŒæŠŠmybatiså‡çº§æˆmybatisplusï¼Œé‡Œé¢åˆ†é¡µæ’ä»¶ é‡‡ç”¨ pagehelper+mybatisplusè‡ªå¸¦åˆ†é¡µ å¹¶å­˜çš„æ–¹å¼ã€‚</p>
<ul>
<li>æ·»åŠ ä¾èµ–</li>
</ul>
<pre><code class="language-xml"> &lt;dependency&gt;
            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;3.4.3&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.pagehelper&lt;/groupId&gt;
            &lt;artifactId&gt;pagehelper-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;1.3.0&lt;/version&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
                    &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency
</code></pre>
<ul>
<li>mybatisplus+ åˆ†é¡µ é…ç½®</li>
</ul>
<pre><code class="language-java">    @Bean
    @ConfigurationProperties(prefix = &quot;pagehelper&quot;)
    public Properties pageHelperProperties() {
        return new Properties();
    }
   @Bean
    public MybatisSqlSessionFactoryBean sqlSessionFactoryBean() throws Exception {
        MybatisSqlSessionFactoryBean sessionFactory = new MybatisSqlSessionFactoryBean();
        Interceptor[] plugins = new Interceptor[2];
        plugins[0] = mybatisPlusInterceptor();
        plugins[1] = pageHelperInterceptor();
        sessionFactory.setPlugins(plugins);
        sessionFactory.setDataSource(dataSource());
        PathMatchingResourcePatternResolver resolver = new PathMatchingResourcePatternResolver();
        sessionFactory.setMapperLocations(resolver.getResources(&quot;classpath*:**/*Mapper.xml&quot;));
        return sessionFactory;
    }
    @Bean
    public PlatformTransactionManager transactionManager() {
        return new DataSourceTransactionManager(dataSource());
    }
    @Bean
    public MybatisPlusInterceptor mybatisPlusInterceptor() {
        MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
        PaginationInnerInterceptor paginationInnerInterceptor = new PaginationInnerInterceptor(DbType.POSTGRE_SQL);
        BlockAttackInnerInterceptor blockAttackInnerInterceptor = new BlockAttackInnerInterceptor();
        //åˆ†é¡µæ’ä»¶
        interceptor.addInnerInterceptor(paginationInnerInterceptor);
        //é˜²æ­¢å…¨è¡¨æ›´æ–°ä¸åˆ é™¤
        interceptor.addInnerInterceptor(blockAttackInnerInterceptor);
        return interceptor;
    }
    @Bean
    public PageInterceptor pageHelperInterceptor() {
        PageInterceptor interceptor = new PageInterceptor();
        interceptor.setProperties(this.pageHelperProperties());
        return interceptor;
    }
</code></pre>
<h1 id="mars-spring-boot-starter-liquibaseåˆæ­¥é›†æˆå¤šæ•°æ®æºåœ¨å¯åŠ¨æ—¶åˆ·æ–°åº“">mars-spring-boot-starter  liquibaseåˆæ­¥é›†æˆï¼ˆå¤šæ•°æ®æºåœ¨å¯åŠ¨æ—¶åˆ·æ–°åº“)</h1>
<ul>
<li>CustomLiquibaseProperties</li>
</ul>
<pre><code class="language-java">public class CustomLiquibaseProperties extends LiquibaseProperties {
    /**
     * æ˜¯å¦æ˜¯é™¤masteræ•°æ®åº“å¤–å…¶ä»–æ•°æ®åº“åŒæ­¥æ›´æ–°
     */
    private boolean global=true;
    public boolean isGlobal() {
        return global;
    }
    public void setGlobal(boolean global) {
        this.global = global;
    }
}


</code></pre>
<p>é¡¹ç›®é…ç½®æ–‡ä»¶é…ç½®</p>
<pre><code class="language-properties">spring.liquibase.enabled=true
spring.liquibase.default-schema=public
spring.liquibase.change-log=classpath:db/changelog/db.changelog-master.xml
spring.liquibase.database-change-log-table=LIQUIBASE_CHANGELOG_TEST
spring.liquibase.database-change-log-lock-table=LIQUIBASE_CHANGELOG_LOCK_TEST

</code></pre>
<ul>
<li>
<p>LiquibaseConfig</p>
<pre><code class="language-java"></code></pre>
</li>
</ul>
<p>public class LiquibaseConfig {<br>
private CustomLiquibaseProperties properties;<br>
@Bean<br>
@DependsOn(&quot;dataSource&quot;)<br>
public DataSourceSpringLiquibase springLiquibase(DynamicDataSource dataSource) {<br>
DataSourceSpringLiquibase dataSourceSpringLiquibase = new DataSourceSpringLiquibase(dataSource,properties);<br>
return dataSourceSpringLiquibase;<br>
}<br>
}</p>
<pre><code>
- DataSourceSpringLiquibase

```java

public class DataSourceSpringLiquibase implements ResourceLoaderAware {
    public static final String DISABLED_MESSAGE = &quot;Liquibase is disabled&quot;;
    public static final String STARTING_SYNC_MESSAGE = &quot;Starting Liquibase synchronously&quot;;
    public static final String STARTED_MESSAGE = &quot;Liquibase has updated your database in {} ms&quot;;
    public static final String EXCEPTION_MESSAGE = &quot;Liquibase could not start correctly, your database is NOT ready: &quot; + &quot;{}&quot;;
    public static final long SLOWNESS_THRESHOLD = 5; // seconds
    public static final String SLOWNESS_MESSAGE = &quot;Warning, Liquibase took more than {} seconds to start up!&quot;;
    private DynamicDataSource dynamicDataSource;
    private CustomLiquibaseProperties customLiquibaseProperties;
    private ResourceLoader resourceLoader;


    public DataSourceSpringLiquibase(DynamicDataSource dynamicDataSource, CustomLiquibaseProperties customLiquibaseProperties) {
        this.dynamicDataSource = dynamicDataSource;
        this.customLiquibaseProperties = customLiquibaseProperties;
    }
    public void run() throws Exception {
        log.info(&quot;DataSources based multiTenancy enabled&quot;);
        runOnAllDataSources();
    }
    private void runOnAllDataSources() throws Exception {
        Map&lt;Object, DataSource&gt; resolvedDataSources = this.dynamicDataSource.getResolvedDataSources();
        for (Map.Entry&lt;Object, DataSource&gt; entry : resolvedDataSources.entrySet()) {
            Object tenant = entry.getKey();
            String t=(String) tenant;
            if(customLiquibaseProperties.isGlobal()){
                if(t.equals(&quot;master&quot;)){
                    continue;
                }
            }else{
                if(!t.equals(&quot;master&quot;)){
                    continue;
                }
            }
            DataSource dataSource = entry.getValue();
            init(tenant, dataSource);
        }

    }

    private void init(Object tenant, DataSource dataSource) throws LiquibaseException {
        log.info(&quot;Initializing Liquibase for data source &quot; + tenant);
        SpringLiquibase liquibase = getSpringLiquibase(dataSource, customLiquibaseProperties);
        try {
            log.warn(STARTING_SYNC_MESSAGE);
            initDb(liquibase);
        } catch (LiquibaseException e) {
            log.error(EXCEPTION_MESSAGE, e.getMessage(), e);
            throw e;
        }
        log.info(&quot;Liquibase run for data source &quot; + tenant);
    }

    private void initDb(SpringLiquibase liquibase) throws LiquibaseException {
        StopWatch watch = new StopWatch();
        watch.start();
        liquibase.afterPropertiesSet();
        watch.stop();
        log.debug(STARTED_MESSAGE, watch.getTotalTimeMillis());
        if (watch.getTotalTimeMillis() &gt; SLOWNESS_THRESHOLD * 1000L) {
            log.warn(SLOWNESS_MESSAGE, SLOWNESS_THRESHOLD);
        }
    }


    private SpringLiquibase getSpringLiquibase(DataSource dataSource, CustomLiquibaseProperties properties) {
        SpringLiquibase liquibase = new SpringLiquibase();
        liquibase.setChangeLog(properties.getChangeLog());
        liquibase.setChangeLogParameters(properties.getParameters());
        liquibase.setContexts(properties.getContexts());
        liquibase.setLabels(properties.getLabels());
        liquibase.setDropFirst(properties.isDropFirst());
        liquibase.setShouldRun(properties.isEnabled());
        liquibase.setRollbackFile(properties.getRollbackFile());
        liquibase.setResourceLoader(resourceLoader);
        liquibase.setDataSource(dataSource);
        liquibase.setDefaultSchema(properties.getDefaultSchema());
        liquibase.setLiquibaseSchema(properties.getLiquibaseSchema());
        liquibase.setLiquibaseTablespace(properties.getLiquibaseTablespace());
        liquibase.setDatabaseChangeLogTable(properties.getDatabaseChangeLogTable());
        liquibase.setDatabaseChangeLogLockTable(properties.getDatabaseChangeLogLockTable());
        return liquibase;
    }
}

</code></pre>
<ul>
<li>ä¿®æ”¹é¡¹ç›®ApplicationRunnner<br>
runæ–¹æ³•æœ€åæ·»åŠ </li>
</ul>
<pre><code class="language-java">//åˆ·æ–°æ•°æ®åº“
 dataSourceSpringLiquibase.run(); 
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kubernetes é—®é¢˜å¤„ç†è®°å½•]]></title>
        <id>https://oldcamel.run/post/kubernetes-wen-ti-chu-li-ji-lu/</id>
        <link href="https://oldcamel.run/post/kubernetes-wen-ti-chu-li-ji-lu/">
        </link>
        <updated>2021-05-26T01:28:44.000Z</updated>
        <content type="html"><![CDATA[<h1 id="1-å¼ºåˆ¶åˆ é™¤namespace">1ã€å¼ºåˆ¶åˆ é™¤namespace</h1>
<p>kubectl get namespace rook-ceph -o json &gt; rook-ceph.json<br>
vim rook-ceph.json<br>
åˆ é™¤specä¸­çš„å†…å®¹<br>
<code>&quot;spec&quot;: { }</code><br>
å¼€å¯kube-proxy   kubectl proxy</p>
<p>å¦å¼€ä¸€ä¸ªsshç™»å½•masterï¼Œæ‰§è¡Œ<br>
<code>curl -k -H &quot;Content-Type: application/json&quot; -X PUT --data-binary @rook-ceph.json http://127.0.0.1:8001/api/v1/namespaces/rook-ceph/finalize</code><br>
æ“ä½œå®ŒæˆğŸ‘Œ</p>
<h1 id="2-kubectl-get-pod-è·å–ä¸åˆ°èµ„æº">2ã€kubectl get pod è·å–ä¸åˆ°èµ„æº</h1>
<p>å¤§æ¦‚ç‡æ˜¯èŠ‚ç‚¹ç½‘ç»œæ’ä»¶å‡ºç°äº†é—®é¢˜ã€‚é‡å¯istiod æœåŠ¡å°è¯•å°†å…¶è¿è¡Œåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Šè¯•ä¸‹</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Flink Sql å®ç°CDCæ•°æ®å®æ—¶åŒæ­¥ç‰¹æ®Šå¤„ç†]]></title>
        <id>https://oldcamel.run/post/flink-sql-shi-xian-cdc-shu-ju-shi-shi-tong-bu-te-shu-chu-li/</id>
        <link href="https://oldcamel.run/post/flink-sql-shi-xian-cdc-shu-ju-shi-shi-tong-bu-te-shu-chu-li/">
        </link>
        <updated>2021-04-15T01:06:21.000Z</updated>
        <content type="html"><![CDATA[<h1 id="1-decimal-ç±»å‹åœ¨kafkaä¸­è§£æä¸ºä¹±ç ">1ã€decimal ç±»å‹åœ¨kafkaä¸­è§£æä¸ºä¹±ç </h1>
<p>kafka connect æ’ä»¶è®¾ç½® &quot;decimal.handling.mode&quot;: &quot;string&quot; å±æ€§ã€‚å°†decimalè§£æä¸ºå­—ç¬¦ä¸²</p>
<p>sqlè¯­å¥ä¸­å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­— ç”¨CAST(å­—æ®µåç§°) AS INT) å‡½æ•°  INTå¯æ ¹æ®ä¸åŒç±»å‹çš„æ•°å­—æ›¿æ¢ä¸ºä¸åŒçš„ç›®æ ‡ç±»å‹ï¼ˆDECIMAL(10,4) BIGINT ç­‰ï¼‰</p>
<h1 id="2-æ—¥æœŸå¤„ç†">2ã€æ—¥æœŸå¤„ç†</h1>
<p>kafkaä¸­äººæ—¥æœŸç±»å‹ä¼šè§£ææˆæ—¶é—´æˆ³ï¼Œå¯ç”¨TO_TIMESTAMP + FROM_UNIXTIMEåšè½¬æ¢ï¼Œæ³¨æ„å¤„ç†æ—¶åŒºé—®é¢˜</p>
<p>oracleæ—¥æœŸç±»å‹å¤„ç†ç²¾åº¦+æ—¶åŒºï¼š</p>
<pre><code>CREATED_DATETS AS TO_TIMESTAMP(FROM_UNIXTIME(CREATED_DATE/1000/1000-8 * 60 * 60, 'yyyy-MM-dd HH:mm:ss')),
</code></pre>
<p>å…¶ä»–æ•°æ®åº“æ—¥æœŸç±»å‹åªå¤„ç†æ—¥æœŸ</p>
<pre><code>FDateTS AS TO_TIMESTAMP(FROM_UNIXTIME((FDate-8 * 60 * 60 * 1000) / 1000, 'yyyy-MM-dd HH:mm:ss'))
</code></pre>
<h1 id="3-cdcæ•°æ®æ’å…¥è®¾ç½®ä¸»é”®">3ã€cdcæ•°æ®æ’å…¥è®¾ç½®ä¸»é”®</h1>
<pre><code>PRIMARY KEY (AAA,BBB) NOT ENFORCED
</code></pre>
<h1 id="4-kafka-sink-sasl-connectæ’ä»¶è®¾ç½®è®¤è¯">4ã€kafka sink sasl connectæ’ä»¶è®¾ç½®è®¤è¯</h1>
<pre><code>&quot;database.history.producer.sasl.mechanism&quot;: &quot;PLAIN&quot;,
&quot;database.history.producer.sasl.jaas.config&quot;: &quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;admin\&quot; password=\&quot;å¯†ç \&quot;;&quot;,
&quot;database.history.producer.security.protocol&quot;: &quot;SASL_PLAINTEXT&quot;,
&quot;database.history.consumer.sasl.jaas.config&quot;: &quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;admin\&quot; password=\&quot;å¯†ç \&quot;;&quot;,
&quot;database.history.consumer.security.protocol&quot;: &quot;SASL_PLAINTEXT&quot;,
&quot;database.history.consumer.sasl.mechanism&quot;: &quot;PLAIN&quot;
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kafkaå®ç°oracleçš„CDCæ•°æ®å®æ—¶å˜æ›´]]></title>
        <id>https://oldcamel.run/post/kafka-shi-xian-oracle-de-cdc-shu-ju-shi-shi-bian-geng/</id>
        <link href="https://oldcamel.run/post/kafka-shi-xian-oracle-de-cdc-shu-ju-shi-shi-bian-geng/">
        </link>
        <updated>2021-04-14T06:02:54.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ä½¿ç”¨å·¥å…·-debezium-oracle-connectororacle-logminer">ä½¿ç”¨å·¥å…·  debezium-oracle-connector,oracle-LogMiner</h1>
<h2 id="1-oracle-è®¾ç½®">1ã€oracle è®¾ç½®</h2>
<h3 id="å¼€å¯å½’æ¡£æ¨¡å¼">å¼€å¯å½’æ¡£æ¨¡å¼</h3>
<pre><code class="language-sqlplus">alter system set db_recovery_file_dest_size = 10G;
alter system set db_recovery_file_dest = '/home/oracle/oradta/recovery_area' scope=spfile;
shutdown immediate
startup mount
alter database archivelog;
alter database open;
archive log list
exit;

ALTER DATABASE ADD SUPPLEMENTAL LOG DATA (ALL) COLUMNS;

</code></pre>
<h4 id="åˆ›å»ºç”¨æˆ·">åˆ›å»ºç”¨æˆ·</h4>
<pre><code>CREATE USER myuser IDENTIFIED BY dbz
   DEFAULT TABLESPACE å‘½åç©ºé—´
   QUOTA UNLIMITED ON å‘½åç©ºé—´
</code></pre>
<h4 id="æˆæƒ">æˆæƒ</h4>
<pre><code>GRANT CREATE SESSION TO myuser;
GRANT CREATE TABLE TO myuser;
GRANT CREATE SEQUENCE TO myuser;
GRANT CREATE TRIGGER TO myuser;
GRANT CREATE SESSION TO myuser;
GRANT SELECT ON V_$DATABASE to myuser;
GRANT FLASHBACK ANY TABLE TO myuser;
GRANT SELECT ANY TABLE TO myuser;
GRANT SELECT_CATALOG_ROLE TO myuser;
GRANT EXECUTE_CATALOG_ROLE TO myuser;
GRANT SELECT ANY TRANSACTION TO myuser;
GRANT CREATE TABLE TO myuser;
GRANT LOCK ANY TABLE TO myuser;
GRANT ALTER ANY TABLE TO myuser;
GRANT CREATE SEQUENCE TO myuser;
GRANT EXECUTE ON DBMS_LOGMNR TO myuser;
GRANT EXECUTE ON DBMS_LOGMNR_D TO myuser;
GRANT SELECT ON V_$LOG TO myuser;
GRANT SELECT ON V_$LOG_HISTORY TO myuser;
GRANT SELECT ON V_$LOGMNR_LOGS TO myuser;
GRANT SELECT ON V_$LOGMNR_CONTENTS TO myuser;
GRANT SELECT ON V_$LOGMNR_PARAMETERS TO myuser;
GRANT SELECT ON V_$LOGFILE TO myuser;
GRANT SELECT ON V_$ARCHIVED_LOG TO myuser;
GRANT SELECT ON V_$ARCHIVE_DEST_STATUS TO myuser;
GRANT SELECT ON SYSTEM.LOGMNR_COL$ TO myuser;
GRANT SELECT ON SYSTEM.LOGMNR_OBJ$ TO myuser;
GRANT SELECT ON SYSTEM.LOGMNR_USER$ TO myuser;
GRANT SELECT ON SYSTEM.LOGMNR_UID$ TO myuser;
</code></pre>
<h2 id="oracleå®¢æˆ·ç«¯è®¾ç½®">oracleå®¢æˆ·ç«¯è®¾ç½®</h2>
<h3 id="ä¸‹è½½">ä¸‹è½½</h3>
<pre><code>wget &quot;https://download.oracle.com/otn_software/linux/instantclient/19600/instantclient-basiclite-linux.x64-19.6.0.0.0dbru.zip&quot; -O /tmp/ic.zipï¼›
unzip /tmp/ic.zip -d  è‡ªå®šä¹‰ç›®å½•
</code></pre>
<h3 id="ç¯å¢ƒå˜é‡">ç¯å¢ƒå˜é‡</h3>
<p>è®¾ç½®LD_LIBRARY_PATH æŒ‡å‘ è‡ªå®šä¹‰ç›®å½•</p>
<h2 id="kafaka-connect-æ’ä»¶è®¾ç½®">kafaka connect æ’ä»¶è®¾ç½®</h2>
<h3 id="ä¸‹è½½-2">ä¸‹è½½</h3>
<pre><code>wget &quot;https://oss.sonatype.org/service/local/artifact/maven/redirect?r=snapshots&amp;g=io.debezium&amp;a=debezium-connector-oracle&amp;v=LATEST&amp;c=plugin&amp;e=tar.gz&quot; -O /tmp/dbz-ora.tgzï¼›
tar -xvf /tmp/dbz-ora.tgz --directory  kafaka æ’ä»¶ç›®å½•
</code></pre>
<h3 id="æ·»åŠ -ojdbc-jaråˆ°æ’ä»¶ç›®å½•">æ·»åŠ  ojdbc jaråˆ°æ’ä»¶ç›®å½•</h3>
<pre><code>      curl https://maven.xwiki.org/externals/com/oracle/jdbc/ojdbc8/12.2.0.1/ojdbc8-12.2.0.1.jar -o ojdbc8-12.2.0.1.jar
</code></pre>
<h2 id="åˆ›å»ºkafka-connect">åˆ›å»ºkafka connect</h2>
<pre><code>curl --location --request POST 'http://localhost:8083/connectors' \
--header 'Content-Type: application/json' \
--data-raw '{
   &quot;name&quot;: &quot;name&quot;,
   &quot;config&quot;: {
       &quot;connector.class&quot; : &quot;io.debezium.connector.oracle.OracleConnector&quot;,
       &quot;tasks.max&quot; : &quot;1&quot;,
       &quot;database.server.name&quot; : &quot;topic&quot;,
       &quot;database.hostname&quot; : &quot;database_host&quot;,
       &quot;database.port&quot; : &quot;1521&quot;,
       &quot;database.user&quot; : &quot;myuser&quot;,
       &quot;database.password&quot; : &quot;dbz&quot;,
       &quot;database.dbname&quot; : &quot;orcl&quot;,
       &quot;database.tablename.case.insensitive&quot;: &quot;true&quot;,
       &quot;database.history.kafka.bootstrap.servers&quot; : &quot;localhost:9092&quot;,
       &quot;database.history.kafka.topic&quot;: &quot;name-h&quot;,
       &quot;table.include.list&quot;:&quot;AAA.BBB,CCC.DDD&quot;,
        &quot;database.history.producer.sasl.mechanism&quot;: &quot;PLAIN&quot;,
       &quot;database.history.producer.sasl.jaas.config&quot;:         &quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;admin\&quot; password=\&quot;password\&quot;;&quot;,
   &quot;database.history.producer.security.protocol&quot;: &quot;SASL_PLAINTEXT&quot;,
    &quot;database.history.consumer.sasl.jaas.config&quot;:          &quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;admin\&quot;   password=\&quot;password\&quot;;&quot;,
     &quot;database.history.consumer.security.protocol&quot;: &quot;SASL_PLAINTEXT&quot;,
       &quot;database.history.consumer.sasl.mechanism&quot;: &quot;PLAIN&quot;
   }
}'
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[linux å®‰è£…æœåŠ¡å™¨èµ„æºç›‘æ§ prometheusè¿œç¨‹å†™å…¥]]></title>
        <id>https://oldcamel.run/post/linux-an-zhuang-fu-wu-qi-zi-yuan-jian-kong-prometheus-yuan-cheng-xie-ru/</id>
        <link href="https://oldcamel.run/post/linux-an-zhuang-fu-wu-qi-zi-yuan-jian-kong-prometheus-yuan-cheng-xie-ru/">
        </link>
        <updated>2021-03-11T01:07:36.000Z</updated>
        <content type="html"><![CDATA[<h2 id="1å®‰è£…prometheus">1.å®‰è£…prometheus</h2>
<pre><code>wgetÂ -cÂ https://github.com/prometheus/prometheus/releases/download/v2.23.0/prometheus-2.23.0.linux-amd64.tar.gzÂ 
tarÂ zxvfÂ prometheus-2.23.0.linux-amd64.tar.gzÂ Â -CÂ /opt/Â 
cdÂ /opt/Â 
lnÂ -sÂ prometheus-2.23.0.linux-amd64Â prometheusÂ 
catÂ &gt;Â /etc/systemd/system/prometheus.serviceÂ &lt;&lt;EOFÂ 
[Unit]Â 
Description=prometheusÂ 
After=network.targetÂ 
[Service]Â 
Type=simpleÂ 
WorkingDirectory=/opt/prometheusÂ 
ExecStart=/opt/prometheus/prometheusÂ --config.file=/opt/prometheus/prometheus.yml
LimitNOFILE=65536Â 
PrivateTmp=trueÂ 
RestartSec=2Â 
StartLimitInterval=0Â 
Restart=alwaysÂ 
[Install]Â 
WantedBy=multi-user.targetÂ 
EOFÂ 
systemctlÂ daemon-reloadÂ Â 
systemctlÂ enableÂ prometheusÂ 
systemctlÂ startÂ prometheusÂ 

</code></pre>
<h3 id="2é…ç½®prometheus">2.é…ç½®Prometheus</h3>
<pre><code>catÂ &gt;Â /opt/prometheus/prometheus.ymlÂ &lt;&lt;EOFÂ 
#Â myÂ globalÂ configÂ 
global:Â 
Â Â scrape_interval:Â Â Â Â Â 15sÂ #Â SetÂ theÂ scrapeÂ intervalÂ toÂ everyÂ 15Â seconds.Â DefaultÂ isÂ everyÂ 1Â minute.Â 
Â Â evaluation_interval:Â 15sÂ #Â EvaluateÂ rulesÂ everyÂ 15Â seconds.Â TheÂ defaultÂ isÂ everyÂ 1Â minute.Â 
Â Â #Â scrape_timeoutÂ isÂ setÂ toÂ theÂ globalÂ defaultÂ (10s).Â 
  external_labels:
        tenant: &quot;140test&quot;
remote_write:
  - url: &quot;url&quot;
    basic_auth:
      username: ç”¨æˆ·å
      password: å¯†ç 
#Â AlertmanagerÂ configurationÂ 
alerting:Â 
Â Â alertmanagers:Â 
Â Â -Â static_configs:Â 
Â Â Â Â -Â targets:Â 
Â Â Â Â Â Â #Â -Â alertmanager:9093Â 
#Â LoadÂ rulesÂ onceÂ andÂ periodicallyÂ evaluateÂ themÂ accordingÂ toÂ theÂ globalÂ 'evaluation_interval'.Â 
rule_files:Â 
Â Â #Â -Â &quot;first_rules.yml&quot;Â 
Â Â #Â -Â &quot;second_rules.yml&quot;Â 
#Â AÂ scrapeÂ configurationÂ containingÂ exactlyÂ oneÂ endpointÂ toÂ scrape:Â 
#Â HereÂ it'sÂ PrometheusÂ itself.Â 
scrape_configs:Â 
Â Â #Â TheÂ jobÂ nameÂ isÂ addedÂ asÂ aÂ labelÂ `job=&lt;job_name&gt;`Â toÂ anyÂ timeseriesÂ scrapedÂ fromÂ thisÂ config.Â 
Â Â -Â job_name:Â 'servers'Â 
Â Â Â Â file_sd_configs:Â 
Â Â Â Â -Â refresh_interval:Â 61sÂ 
Â Â Â Â Â Â files:Â 
Â Â Â Â Â Â Â Â -Â /opt/prometheus/servers/*.jsonÂ 
EOFÂ 

</code></pre>
<h2 id="3åˆ›å»ºnodeé…ç½®æ–‡ä»¶">3.åˆ›å»ºnodeé…ç½®æ–‡ä»¶</h2>
<pre><code>mkdir -p /opt/prometheus/servers
cd /opt/prometheus/servers
vim json.json
[Â Â Â Â Â 
Â Â Â Â {Â 
Â Â Â Â Â Â Â Â &quot;targets&quot;:Â [Â 
Â Â Â Â Â Â Â Â Â Â Â Â â€œxxx.xxx.xxx.xxx:9100&quot;Â 
Â Â Â Â Â Â Â Â ],Â 
Â Â Â Â Â Â Â Â &quot;labels&quot;:Â {Â 
Â Â Â Â Â Â Â Â Â Â Â Â &quot;instance&quot;:Â &quot;xxx.xxx.xxx.xxx&quot;,Â 
Â Â Â Â Â Â Â Â Â Â Â Â &quot;job&quot;:Â &quot;node_exporter&quot;Â 
Â Â Â Â Â Â Â Â }Â 
Â Â Â Â }
Â Â Â 
]Â 
</code></pre>
<h2 id="å®‰è£…node_exporter">å®‰è£…node_exporter</h2>
<pre><code>Wget https://github.com/prometheus/node_exporter/releases/download/v1.0.1/node_exporter-1.0.1.linux-amd64.tar.gzÂ 
tarÂ zxvfÂ node_exporter-1.0.1.linux-amd64.tar.gzÂ -CÂ /opt/Â 
cdÂ /opt/Â 
lnÂ -sÂ Â node_exporter-1.0.1.linux-amd64Â node_exporterÂ 
catÂ &gt;Â /etc/systemd/system/node_exporter.serviceÂ &lt;&lt;EOFÂ 
[Unit]Â 
Description=node_exporterÂ 
After=network.targetÂ 
[Service]Â 
Type=simpleÂ 
WorkingDirectory=/opt/node_exporterÂ 
ExecStart=/opt/node_exporter/node_exporterÂ 
LimitNOFILE=65536Â 
PrivateTmp=trueÂ 
RestartSec=2Â 
StartLimitInterval=0Â 
Restart=alwaysÂ 
[Install]Â 
WantedBy=multi-user.targetÂ 
EOFÂ 
systemctlÂ daemon-reloadÂ 
systemctlÂ enableÂ node_exporterÂ 
systemctlÂ startÂ node_exporterÂ 
systemctlÂ restartÂ prometheusÂ 

</code></pre>
<h2 id="æŸ¥çœ‹æœåŠ¡æ—¥å¿—å‘½ä»¤">æŸ¥çœ‹æœåŠ¡æ—¥å¿—å‘½ä»¤</h2>
<pre><code>journalctl -u prometheus
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kafkaå®ç°sqlserverçš„CDCæ•°æ®å®æ—¶å˜æ›´]]></title>
        <id>https://oldcamel.run/post/kafka-shi-xian-sqlserver-de-cdc-shu-ju-shi-shi-bian-geng/</id>
        <link href="https://oldcamel.run/post/kafka-shi-xian-sqlserver-de-cdc-shu-ju-shi-shi-bian-geng/">
        </link>
        <updated>2021-01-08T02:29:39.000Z</updated>
        <content type="html"><![CDATA[<h2 id="å®‰è£…sqlserver">å®‰è£…sqlserver</h2>
<pre><code>#!/bin/bash -e
# Password for the SA user (required)
# è®¾ç½®å¯†ç 
MSSQL_SA_PASSWORD='test@12345678'

# Product ID of the version of SQL server you're installing
# Must be evaluation, developer, express, web, standard, enterprise, or your 25 digit product key
# Defaults to developer
# é€‰æ‹©ç‰ˆæœ¬ï¼Œæœ‰å¤šç§ç‰ˆæœ¬å¯ä¾›åŸåˆ™ï¼Œå…·ä½“ç‰ˆæœ¬æ ‡è¯†ç¬¦å¯è‡ªè¡Œç™¾åº¦
MSSQL_PID='evaluation'

# Install SQL Server Agent (recommended)
SQL_ENABLE_AGENT='y'

# Install SQL Server Full Text Search (optional)
# SQL_INSTALL_FULLTEXT='y'

# Create an additional user with sysadmin privileges (optional)
# æ–°å»ºä¸€ä¸ªé¢å¤–æ·»åŠ çš„ç”¨æˆ·ï¼Œï¼ˆå¯é€‰ï¼‰
# SQL_INSTALL_USER='&lt;Username&gt;'
# SQL_INSTALL_USER_PASSWORD='&lt;YourStrong!Passw0rd&gt;'

if [ -z $MSSQL_SA_PASSWORD ]
then
  echo Environment variable MSSQL_SA_PASSWORD must be set for unattended install
  exit 1
fi

# --------------------------- è¿œç¨‹æ‹‰åŒ… å¹¶å®‰è£…çš„è¿‡ç¨‹
echo Adding Microsoft repositories...
sudo curl -o /etc/yum.repos.d/mssql-server.repo https://packages.microsoft.com/config/rhel/7/mssql-server-2017.repo
sudo curl -o /etc/yum.repos.d/msprod.repo https://packages.microsoft.com/config/rhel/7/prod.repo

echo Installing SQL Server...
sudo yum install -y mssql-server

# --------------------------- ä¸‹é¢ç»™å‡º æœ¬åœ°ç¦»çº¿rpmåŒ…å®‰è£…éƒ¨åˆ†è„šæœ¬
echo ï¼šLocal Installing SQL Server...
sudo yum localinstall -y ./sqlserver2017.rpm



# æ‰§è¡Œsqlserverçš„é…ç½®
echo Running mssql-conf setup...
sudo MSSQL_SA_PASSWORD=$MSSQL_SA_PASSWORD \
     MSSQL_PID=$MSSQL_PID \
     /opt/mssql/bin/mssql-conf -n setup accept-eula

echo Installing mssql-tools and unixODBC developer...
sudo ACCEPT_EULA=Y yum install -y mssql-tools unixODBC-devel

# Add SQL Server tools to the path by default:
echo Adding SQL Server tools to your path...
echo PATH=&quot;$PATH:/opt/mssql-tools/bin&quot; &gt;&gt; ~/.bash_profile
echo 'export PATH=&quot;$PATH:/opt/mssql-tools/bin&quot;' &gt;&gt; ~/.bashrc
source ~/.bashrc

# Optional Enable SQL Server Agent :
if [ ! -z $SQL_ENABLE_AGENT ]
then
  echo Enable SQL Server Agent...
  sudo /opt/mssql/bin/mssql-conf set sqlagent.enabled true
  sudo systemctl restart mssql-server
fi

# Optional SQL Server Full Text Search installation:
if [ ! -z $SQL_INSTALL_FULLTEXT ]
then
    echo Installing SQL Server Full-Text Search...
    sudo yum install -y mssql-server-fts
fi

# Configure firewall to allow TCP port 1433:
# é…ç½®é˜²ç«å¢™æ”¾è¡Œ1433ç«¯å£ï¼Œæ‡’çœäº‹ç›´æ¥å…³æ‰é˜²ç«å¢™äº¦å¯
echo Configuring firewall to allow traffic on port 1433...
sudo firewall-cmd --zone=public --add-port=1433/tcp --permanent
sudo firewall-cmd --reload

# Example of setting post-installation configuration options
# Set trace flags 1204 and 1222 for deadlock tracing:
#echo Setting trace flags...
#sudo /opt/mssql/bin/mssql-conf traceflag 1204 1222 on

# Restart SQL Server after making configuration changes:
# é‡å¯
echo Restarting SQL Server...
sudo systemctl restart mssql-server

# Connect to server and get the version:
# å®˜æ–¹ç»™å‡ºçš„æµ‹è¯•é“¾æ¥è„šæœ¬
counter=1
errstatus=1
while [ $counter -le 5 ] &amp;&amp; [ $errstatus = 1 ]
do
  echo Waiting for SQL Server to start...
  sleep 5s
  /opt/mssql-tools/bin/sqlcmd \
    -S localhost \
    -U SA \
    -P $MSSQL_SA_PASSWORD \
    -Q &quot;SELECT @@VERSION&quot; 2&gt;/dev/null
  errstatus=$?
  ((counter++))
done

# Display error if connection failed:
if [ $errstatus = 1 ]
then
  echo Cannot connect to SQL Server, installation aborted
  exit $errstatus
fi

# Optional new user creation:
if [ ! -z $SQL_INSTALL_USER ] &amp;&amp; [ ! -z $SQL_INSTALL_USER_PASSWORD ]
then
  echo Creating user $SQL_INSTALL_USER
  /opt/mssql-tools/bin/sqlcmd \
    -S localhost \
    -U SA \
    -P $MSSQL_SA_PASSWORD \
    -Q &quot;CREATE LOGIN [$SQL_INSTALL_USER] WITH PASSWORD=N'$SQL_INSTALL_USER_PASSWORD', DEFAULT_DATABASE=[master], CHECK_EXPIRATION=ON, CHECK_POLICY=ON; ALTER SERVER ROLE [sysadmin] ADD MEMBER [$SQL_INSTALL_USER]&quot;
fi

echo Done!
</code></pre>
<p>è¿è¡Œè„šæœ¬ç­‰ç€å®‰è£…å®Œæˆ</p>
<h2 id="å¼€å¯è¡¨çš„cdc">å¼€å¯è¡¨çš„cdc</h2>
<h3 id="åˆ›å»ºshihuæ•°æ®åº“">åˆ›å»ºshihuæ•°æ®åº“</h3>
<h3 id="å»ºæµ‹è¯•è¡¨">å»ºæµ‹è¯•è¡¨</h3>
<pre><code>IF EXISTS (SELECT * FROM sys.all_objects WHERE object_id = OBJECT_ID(N'[dbo].[dt_test]') AND type IN ('U'))
	DROP TABLE [dbo].[dt_test]
GO

CREATE TABLE [dbo].[dt_test] (
  [tid] int  NOT NULL,
  [tname] nvarchar(200) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [tidcard] nvarchar(200) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [tbirthday] date  NULL,
  [tmobile] nvarchar(200) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [temail] nvarchar(200) COLLATE SQL_Latin1_General_CP1_CI_AS  NULL,
  [tgender] bigint  NULL,
  [tcreate_time] datetime  NULL
)
GO

ALTER TABLE [dbo].[dt_test] SET (LOCK_ESCALATION = TABLE)
GO


-- ----------------------------
-- Primary Key structure for table dt_test
-- ----------------------------
ALTER TABLE [dbo].[dt_test] ADD CONSTRAINT [PK__dt_test__DC105B0FA908205A] PRIMARY KEY CLUSTERED ([tid])
WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON)  
ON [PRIMARY]
GO

</code></pre>
<h3 id="å¼€å¯cdc">å¼€å¯cdc</h3>
<pre><code>USE shihu
GO
EXEC sys.sp_cdc_enable_db
GO

USE shihu
GO
EXEC sys.sp_cdc_enable_table
@source_schema = 'dbo',
@source_name   = â€˜dt_testâ€™,     
@role_name     = NULL,
@filegroup_name = 'PRIMARY',      
@supports_net_changes = 1
GO
</code></pre>
<h2 id="ä¸‹è½½kafkaæ’ä»¶">ä¸‹è½½kafkaæ’ä»¶</h2>
<h3 id="å®˜æ–¹æ–‡æ¡£">å®˜æ–¹æ–‡æ¡£</h3>
<p><a href="https://debezium.io/documentation/reference/1.3/connectors/sqlserver.html">https://debezium.io/documentation/reference/1.3/connectors/sqlserver.html</a></p>
<h3 id="ä¸‹è½½">ä¸‹è½½</h3>
<p><a href="https://repo1.maven.org/maven2/io/debezium/debezium-connector-sqlserver/1.2.5.Final/debezium-connector-sqlserver-1.2.5.Final-plugin.tar.gz">https://repo1.maven.org/maven2/io/debezium/debezium-connector-sqlserver/1.2.5.Final/debezium-connector-sqlserver-1.2.5.Final-plugin.tar.gz</a></p>
<h3 id="åˆ›å»ºæ’ä»¶ç›®å½•">åˆ›å»ºæ’ä»¶ç›®å½•</h3>
<p>åœ¨kafkaè·Ÿç›®å½•åˆ›å»º kafka_connect_plugins ç›®å½•<br>
å°†ä¸‹è½½çš„åŒ…è§£å‹åˆ°æ­¤ç›®å½•ä¸­<br>
<img src="https://oldcamel.run/post-images/1610074594464.png" alt="" loading="lazy"></p>
<h3 id="ä¿®æ”¹kafkaconfigconnect-distributeproperties">ä¿®æ”¹kafka/config/connect-distribute.properties</h3>
<p>bootstrap.servers=IP:9092<br>
plugin.path=Â /kafkaè·¯å¾„/kafka_connect_plugins</p>
<h3 id="å¯åŠ¨kafka-connect">å¯åŠ¨kafka-connect</h3>
<pre><code>./bin/connect-distributed.sh  config/connect-distributed.properties &gt;logs/ksc.log &amp;
</code></pre>
<p>å¼€å¯æˆåŠŸçš„æ ‡å¿—,postmanå¯ä»¥ä½¿ç”¨è®¿é—®ç«¯å£8083ï¼ˆé»˜è®¤çš„ç«¯å£å·,å¯ä»¥åœ¨connect-distributed.properties æ›´æ”¹ï¼‰</p>
<h4 id="rest-api">rest api</h4>
<pre><code>GET /connectors â€“ è¿”å›æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„connectorå
POST /connectors â€“ æ–°å»ºä¸€ä¸ªconnector; è¯·æ±‚ä½“å¿…é¡»æ˜¯jsonæ ¼å¼å¹¶ä¸”éœ€è¦åŒ…å«nameå­—æ®µå’Œconfigå­—æ®µï¼Œnameæ˜¯connectorçš„åå­—ï¼Œconfigæ˜¯jsonæ ¼å¼ï¼Œå¿…é¡»åŒ…å«ä½ çš„connectorçš„é…ç½®ä¿¡æ¯ã€‚
GET /connectors/{name} â€“ è·å–æŒ‡å®šconnetorçš„ä¿¡æ¯
GET /connectors/{name}/config â€“ è·å–æŒ‡å®šconnectorçš„é…ç½®ä¿¡æ¯
PUT /connectors/{name}/config â€“ æ›´æ–°æŒ‡å®šconnectorçš„é…ç½®ä¿¡æ¯
GET /connectors/{name}/status â€“ è·å–æŒ‡å®šconnectorçš„çŠ¶æ€ï¼ŒåŒ…æ‹¬å®ƒæ˜¯å¦åœ¨è¿è¡Œã€åœæ­¢ã€æˆ–è€…å¤±è´¥ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œè¿˜ä¼šåˆ—å‡ºé”™è¯¯çš„å…·ä½“ä¿¡æ¯ã€‚
GET /connectors/{name}/tasks â€“ è·å–æŒ‡å®šconnectoræ­£åœ¨è¿è¡Œçš„taskã€‚
GET /connectors/{name}/tasks/{taskid}/status â€“ è·å–æŒ‡å®šconnectorçš„taskçš„çŠ¶æ€ä¿¡æ¯
PUT /connectors/{name}/pause â€“ æš‚åœconnectorå’Œå®ƒçš„taskï¼Œåœæ­¢æ•°æ®å¤„ç†çŸ¥é“å®ƒè¢«æ¢å¤ã€‚
PUT /connectors/{name}/resume â€“ æ¢å¤ä¸€ä¸ªè¢«æš‚åœçš„connector
POST /connectors/{name}/restart â€“ é‡å¯ä¸€ä¸ªconnectorï¼Œå°¤å…¶æ˜¯åœ¨ä¸€ä¸ªconnectorè¿è¡Œå¤±è´¥çš„æƒ…å†µä¸‹æ¯”è¾ƒå¸¸ç”¨
POST /connectors/{name}/tasks/{taskId}/restart â€“ é‡å¯ä¸€ä¸ªtaskï¼Œä¸€èˆ¬æ˜¯å› ä¸ºå®ƒè¿è¡Œå¤±è´¥æ‰è¿™æ ·åšã€‚
DELETE /connectors/{name} â€“ åˆ é™¤ä¸€ä¸ªconnectorï¼Œåœæ­¢å®ƒçš„æ‰€æœ‰taskå¹¶åˆ é™¤é…ç½®ã€‚
</code></pre>
<h4 id="æ·»åŠ sqlserver-connect">æ·»åŠ sqlserver connect</h4>
<pre><code>curl --location --request POST 'http://localhost:8083/connectors' \
--header 'Content-Type: application/json' \
--data-raw '{
    &quot;name&quot;: &quot;sqlserver178-connector&quot;,
    &quot;config&quot;: {
        &quot;connector.class&quot;: &quot;io.debezium.connector.sqlserver.SqlServerConnector&quot;,
        &quot;database.hostname&quot;: &quot;sqlserverçš„ip&quot;,
        &quot;database.port&quot;: &quot;1433&quot;,
        &quot;database.user&quot;: &quot;sa&quot;,
        &quot;database.password&quot;: &quot;test@12345678&quot;,
        &quot;database.dbname&quot;: &quot;shihu&quot;,
        &quot;database.server.name&quot;: &quot;fullfillment&quot;,
        &quot;table.whitelist&quot;: &quot;dbo.dt_test&quot;,
        &quot;database.history.kafka.bootstrap.servers&quot;: &quot;kafkaçš„IP:9092&quot;,
        &quot;database.history.kafka.topic&quot;: &quot;dbhistory.fullfillment&quot;,
        &quot;database.history.producer.security.protocol&quot;: &quot;SASL_PLAINTEXT&quot;,
        &quot;database.history.producer.sasl.mechanism&quot;: &quot;PLAIN&quot;,
        &quot;database.history.producer.sasl.jaas.config&quot;: &quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;admin\&quot; password=\&quot;123\&quot;;&quot;,
        &quot;database.history.consumer.security.protocol&quot;: &quot;SASL_PLAINTEXT&quot;,
        &quot;database.history.consumer.sasl.mechanism&quot;: &quot;PLAIN&quot;,
        &quot;database.history.consumer.sasl.jaas.config&quot;: &quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;admin\&quot; password=\&quot;123\&quot;;&quot;
    }
}'
</code></pre>
<h3 id="æ¶ˆè´¹ä¿¡æ¯">æ¶ˆè´¹ä¿¡æ¯</h3>
<h4 id="consumerprepertiesé…ç½®">consumer.prepertiesé…ç½®</h4>
<pre><code>bootstrap.servers=localhost:9092
group.id=test-consumer-group
security.protocol=SASL_PLAINTEXT
sasl.mechanism=PLAIN
</code></pre>
<h4 id="ä¿®æ”¹å™¨kafka-console-consumershä¸ºkafka-console-consumer-saalshå€’æ•°ç¬¬äºŒè¡Œæ·»åŠ ">ä¿®æ”¹å™¨kafka-console-consumer.shä¸ºkafka-console-consumer-saal.shå€’æ•°ç¬¬äºŒè¡Œæ·»åŠ </h4>
<pre><code>export KAFKA_OPTS=&quot;-Djava.security.auth.login.config=/opt/kafka/kafka_2.13-2.6.0/config/kafka_client_jaas.conf&quot;
</code></pre>
<h4 id="å¯åŠ¨">å¯åŠ¨</h4>
<pre><code>./bin/kafka-console-consumer-saal.sh --bootstrap-server localhost:9092 --topic fullfillment.dbo.dt_test --consumer.config config/consumer.properties
</code></pre>
<h4 id="æ¶ˆæ¯ç¤ºä¾‹">æ¶ˆæ¯ç¤ºä¾‹</h4>
<pre><code>{
    &quot;schema&quot;:{
        &quot;type&quot;:&quot;struct&quot;,
        &quot;fields&quot;:Array[6],
        &quot;optional&quot;:false,
        &quot;name&quot;:&quot;fullfillment.dbo.dt_test.Envelope&quot;
    },
    &quot;payload&quot;:{
        &quot;before&quot;:{
            &quot;tid&quot;:1,
            &quot;tname&quot;:&quot;222&quot;,
            &quot;tidcard&quot;:&quot;2&quot;,
            &quot;tbirthday&quot;:-25567,
            &quot;tmobile&quot;:&quot;1&quot;,
            &quot;temail&quot;:&quot;1&quot;,
            &quot;tgender&quot;:2,
            &quot;tcreate_time&quot;:-2208988800000
        },
        &quot;after&quot;:{
            &quot;tid&quot;:1,
            &quot;tname&quot;:&quot;test&quot;,
            &quot;tidcard&quot;:&quot;2&quot;,
            &quot;tbirthday&quot;:-25567,
            &quot;tmobile&quot;:&quot;1&quot;,
            &quot;temail&quot;:&quot;1&quot;,
            &quot;tgender&quot;:2,
            &quot;tcreate_time&quot;:-2208988800000
        },
        &quot;source&quot;:Object{...},
        &quot;op&quot;:&quot;u&quot;,
        &quot;ts_ms&quot;:1610019731750,
        &quot;transaction&quot;:null
    }
}
</code></pre>
<h4 id="oracleç¤ºä¾‹">oracleç¤ºä¾‹</h4>
<pre><code>
curl --location --request POST 'http://localhost:8083/connectors/' \
--header 'Content-Type: application/json' \
--data-raw '
{
    &quot;name&quot;: &quot;oracle-61-connector&quot;,
    &quot;config&quot;: {
        &quot;connector.class&quot;: &quot;com.ecer.kafka.connect.oracle.OracleSourceConnector&quot;,
        &quot;db.name.alias&quot;: &quot;61test&quot;,
        &quot;tasks.max&quot;: 1,
        &quot;topic&quot;: &quot;kol&quot;,
        &quot;db.name&quot;: &quot;portaldb&quot;,
        &quot;db.hostname&quot;: &quot;oralceè¿æ¥hoståœ°å€&quot;,
        &quot;db.port&quot;: 1521,
        &quot;db.user&quot;: &quot;info&quot;,
        &quot;db.user.password&quot;: &quot;111111&quot;,
        &quot;db.fetch.size&quot;: 1,
        &quot;table.whitelist&quot;: &quot;INFO.*,SPAUTH.*,WORKFLOW.*,FLOWABLE.*,OA.*&quot;,
        &quot;table.blacklist&quot;: &quot;&quot;,
        &quot;parse.dml.data&quot;: true,
        &quot;reset.offset&quot;: false,
        &quot;multitenant&quot;: false
    }
}
</code></pre>
<h3 id="mysqlç¤ºä¾‹">mysqlç¤ºä¾‹</h3>
<pre><code>curl --location --request POST 'http://localhost:8083/connectors/' \
--header 'Content-Type: application/json' \
--data-raw '
{
  &quot;name&quot;: &quot;140mysql-connector&quot;, 
  &quot;config&quot;: {
    &quot;connector.class&quot;: &quot;io.debezium.connector.mysql.MySqlConnector&quot;, 
    &quot;database.hostname&quot;: &quot;localhost&quot;, 
    &quot;database.port&quot;: &quot;3306&quot;, 
    &quot;database.user&quot;: &quot;root&quot;, 
    &quot;database.password&quot;: &quot;111111&quot;, 
    &quot;database.server.id&quot;: &quot;184054&quot;, 
    &quot;database.server.name&quot;: &quot;fullfillment140ms&quot;, 
    &quot;database.whitelist&quot;:&quot;test&quot;,
    &quot;database.history.kafka.bootstrap.servers&quot;: &quot;localhost:9092&quot;, 
    &quot;database.history.kafka.topic&quot;: &quot;dbhistory.fullfillment140ms&quot;, 
    &quot;include.schema.changes&quot;: &quot;false&quot;,
        &quot;database.history.producer.security.protocol&quot;: &quot;SASL_PLAINTEXT&quot;,
        &quot;database.history.producer.sasl.mechanism&quot;: &quot;PLAIN&quot;,
        &quot;database.history.producer.sasl.jaas.config&quot;: &quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;admin\&quot; password=\&quot;123\&quot;;&quot;,
        &quot;database.history.consumer.security.protocol&quot;: &quot;SASL_PLAINTEXT&quot;,
        &quot;database.history.consumer.sasl.mechanism&quot;: &quot;PLAIN&quot;,
        &quot;database.history.consumer.sasl.jaas.config&quot;: &quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;admin\&quot; password=\&quot;123\&quot;;&quot;
    }
}
</code></pre>
<h3 id="æŸ¥çœ‹topic-list">æŸ¥çœ‹topic list</h3>
<pre><code>bin/kafka-topics.sh --zookeeper localhost --list
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kafkaå¼€å¯SASLç”¨æˆ·åå¯†ç è®¤è¯]]></title>
        <id>https://oldcamel.run/post/kafka-kai-qi-sasl-yong-hu-ming-mi-ma-ren-zheng/</id>
        <link href="https://oldcamel.run/post/kafka-kai-qi-sasl-yong-hu-ming-mi-ma-ren-zheng/">
        </link>
        <updated>2021-01-08T01:51:25.000Z</updated>
        <content type="html"><![CDATA[<h2 id="åˆ›å»ºkafka_server_jaasconfæ–‡ä»¶">åˆ›å»ºkafka_server_jaas.confæ–‡ä»¶</h2>
<p>configç›®å½•ä¸‹åˆ›å»ºkafka_server_jaas.confæ–‡ä»¶</p>
<pre><code>KafkaServer {
  org.apache.kafka.common.security.plain.PlainLoginModule required
  username=&quot;admin&quot;
  password=&quot;123&quot;
  user_admin=&quot;123&quot;
  user_yunzai=&quot;123&quot;;
};
</code></pre>
<h2 id="åˆ›å»ºkafka_client_jaasconfæ–‡ä»¶">åˆ›å»ºkafka_client_jaas.confæ–‡ä»¶</h2>
<p>configç›®å½•ä¸‹åˆ›å»ºkafka_client_jaas.confæ–‡ä»¶</p>
<pre><code>KafkaClient {
        org.apache.kafka.common.security.plain.PlainLoginModule required
        username=&quot;admin&quot;
        password=&quot;123&quot;;
};
</code></pre>
<h2 id="ä¿®æ”¹serverproperties">ä¿®æ”¹server.properties</h2>
<pre><code>listeners=SASL_PLAINTEXT://IP:9092
advertised.listeners=SASL_PLAINTEXT://IP:9092
security.inter.broker.protocol=SASL_PLAINTEXT
sasl.enabled.mechanisms=PLAIN
sasl.mechanism.inter.broker.protocol=PLAIN
authorizer.class.name = kafka.security.auth.SimpleAclAuthorizer
super.users=User:admin;
</code></pre>
<h2 id="ä¿®æ”¹kafakaå¯åŠ¨è„šæœ¬">ä¿®æ”¹kafakaå¯åŠ¨è„šæœ¬</h2>
<p>ä¿®æ”¹binç›®å½•ä¸‹kafka_start.sh<br>
åœ¨å€’æ•°ç¬¬äºŒè¡Œæ·»åŠ kafka_server_jaas.confçš„å…¨è·¯å¾„</p>
<pre><code>export KAFKA_OPTS=&quot;-Djava.security.auth.login.config=/opt/kafka/kafka_2.13-2.6.0/config/kafka_server_jaas.conf&quot;
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://oldcamel.run/post-images/1610071605941.png" alt="" loading="lazy"></figure>
<h2 id="å¯é€‰ä¸ºç‰¹å®šç”¨æˆ·æ·»åŠ ç‰¹å®štopicçš„aclæˆæƒ">ï¼ˆå¯é€‰ï¼‰ä¸ºç‰¹å®šç”¨æˆ·æ·»åŠ ç‰¹å®štopicçš„aclæˆæƒ</h2>
<p>å¦‚ä¸‹è¡¨ç¤ºä¸ºç”¨æˆ·yunzaiæ·»åŠ topic nginx-logçš„è¯»å†™æƒé™ã€‚</p>
<pre><code>./bin/kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 -add --allow-principal User:yunzai  --operation Read --operation Write --topic testyunzai
</code></pre>
<p>éªŒè¯æˆæƒ</p>
<pre><code>./bin/kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 --list --topic testyunzai
</code></pre>
<h3 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…éªŒè¯">ç”Ÿäº§è€…æ¶ˆè´¹è€…éªŒè¯</h3>
<h4 id="ç”Ÿäº§è€…">ç”Ÿäº§è€…</h4>
<p>1.ä»¥ç”¨æˆ·yunzaiä¸ºä¾‹ï¼Œåˆ›å»ºJAASè®¤è¯æ–‡ä»¶yunzai_jaas.confæ”¾åœ¨configç›®å½•ä¸‹ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code>KafkaClient {
org.apache.kafka.common.security.plain.PlainLoginModule required
username=&quot;yunzai&quot;
password=&quot;123&quot;;
};
</code></pre>
<p>2.æ‹·è´bin/kafka-console-producer.shä¸ºbin/yunzai-kafka-console-producer.shï¼Œå¹¶å°†JAASæ–‡ä»¶ä½œä¸ºä¸€ä¸ªJVMå‚æ•°ä¼ ç»™console producer</p>
<p>å€’æ•°ç¬¬äºŒè¡Œæ·»åŠ </p>
<pre><code>export KAFKA_OPTS=&quot;-Djava.security.auth.login.config=/opt/kafka/kafka_2.13-2.6.0/config/yunzai_jaas.conf&quot;
</code></pre>
<p>3.åˆ›å»ºæ–‡ä»¶producer.configæŒ‡å®šå¦‚ä¸‹å±æ€§ï¼š</p>
<pre><code>security.protocol=SASL_PLAINTEXT
sasl.mechanism=PLAIN
</code></pre>
<p>4.å¯åŠ¨producer</p>
<pre><code>./bin/yunzai-kafka-console-producer.sh --broker-list IP:9092 --topic testyunzai --producer.config producer.config
</code></pre>
<h4 id="æ¶ˆè´¹è€…">æ¶ˆè´¹è€…</h4>
<p>1.ä»¥ç”¨æˆ·yunzaiä¸ºä¾‹ï¼Œåˆ›å»ºJAASè®¤è¯æ–‡ä»¶yunzai_jaas.confæ”¾åœ¨configç›®å½•ä¸‹ï¼Œå¦‚æœç”¨æˆ·è·Ÿç”Ÿäº§è€…æ˜¯åŒä¸€ä¸ªï¼Œå¯ä»¥å¤ç”¨ä¸Šé¢ç”Ÿäº§è€…çš„JAASæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:</p>
<pre><code>KafkaClient {
org.apache.kafka.common.security.plain.PlainLoginModule required
username=&quot;yunzai&quot;
password=&quot;123&quot;;
};
</code></pre>
<p>2.æ‹·è´bin/kafka-console-consumer.shä¸ºbin/yunzai-kafka-console-consumer.shï¼Œå¹¶å°†JAASæ–‡ä»¶ä½œä¸ºä¸€ä¸ªJVMå‚æ•°ä¼ ç»™console consumer<br>
å€’æ•°ç¬¬äºŒè¡Œæ·»åŠ </p>
<pre><code>export KAFKA_OPTS=&quot;-Djava.security.auth.login.config=/opt/kafka/kafka_2.13-2.6.0/config/yunzai_jaas.conf&quot;
</code></pre>
<p>3.åˆ›å»ºæ–‡ä»¶consumer.configæŒ‡å®šå¦‚ä¸‹å±æ€§ï¼š</p>
<pre><code>security.protocol=SASL_PLAINTEXT
sasl.mechanism=PLAIN
group.id=test
</code></pre>
<p>4.å¯åŠ¨consumer</p>
<pre><code>./bin/yunzai-kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic testyunzai --from-beginning --consumer.config consumer.config
</code></pre>
<h3 id="java-beamå®¢æˆ·ç«¯è®¤è¯">java beamå®¢æˆ·ç«¯è®¤è¯</h3>
<p>beamè®¾ç½®</p>
<pre><code class="language-java">   final Map&lt;String, Object&gt; immutableMap = new ImmutableMap.Builder&lt;String, Object&gt;()
                .put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, &quot;earliest&quot;)
                .put(ConsumerConfig.GROUP_ID_CONFIG, options.getGroupid())
                .put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, true)
                .put(CommonClientConfigs.SECURITY_PROTOCOL_CONFIG, &quot;SASL_PLAINTEXT&quot;)
                .put(SaslConfigs.SASL_MECHANISM, &quot;PLAIN&quot;)
                .put(SaslConfigs.SASL_JAAS_CONFIG, &quot;org.apache.kafka.common.security.plain.PlainLoginModule required username=\&quot;&quot; + options.getKafkaUsername() + &quot;\&quot; password=\&quot;&quot; + options.getKafkaPassword() + &quot;\&quot;;&quot;)
                .build();
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[VictoriaMetrics æ±‡æ€»å¤šä¸ªPrometheusæŒ‡æ ‡ï¼ˆå››ï¼‰è¯»å–IstioæŒ‡æ ‡]]></title>
        <id>https://oldcamel.run/post/victoriametrics-hui-zong-duo-ge-prometheus-zhi-biao-san-du-qu-istio-zhi-biao/</id>
        <link href="https://oldcamel.run/post/victoriametrics-hui-zong-duo-ge-prometheus-zhi-biao-san-du-qu-istio-zhi-biao/">
        </link>
        <updated>2020-12-25T07:41:53.000Z</updated>
        <content type="html"><![CDATA[<p>istioä¸­é»˜è®¤å¸¦äº†prometheus,é‡Œé¢åŒ…å«istioä»£ç†çš„æŒ‡æ ‡ï¼Œç°éœ€è¦å°†istioä¸­çš„æŒ‡æ ‡é…ç½®åœ¨kube-prometheusä¸­ã€‚</p>
<h2 id="ä¿®æ”¹prometheus-k8s-è§’è‰²æƒé™">ä¿®æ”¹prometheus-k8s è§’è‰²æƒé™</h2>
<p>ä¿®æ”¹prometheus-clusterRole.yaml</p>
<pre><code>apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-k8s
rules:
- apiGroups:
  - &quot;&quot;
  resources:
  - nodes
  - services
  - endpoints
  - pods
  - nodes/proxy
  verbs:
  - get
  - watch
  - list
- apiGroups:
  - &quot;&quot;
  resources:
  - configmaps
  verbs:
  - get
- nonResourceURLs:
  - /metrics
  verbs:
  - get
</code></pre>
<h2 id="é…ç½®æ•°æ®å¹³é¢çš„æœåŠ¡ç›‘æ§">é…ç½®æ•°æ®å¹³é¢çš„æœåŠ¡ç›‘æ§</h2>
<pre><code>apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: prometheus-oper-istio-controlplane
spec:
  jobLabel: istio
  selector:
    matchExpressions:
      - {key: istio, operator: In, values: [mixer,pilot,galley,citadel,sidecar-injector]}
  namespaceSelector:
    any: true
  endpoints:
  - port: http-monitoring
    interval: 15s
  - port: http-policy-monitoring
    interval: 15s

</code></pre>
<h2 id="é…ç½®æ•°æ®å±‚çš„æœåŠ¡ç›‘æ§">é…ç½®æ•°æ®å±‚çš„æœåŠ¡ç›‘æ§</h2>
<pre><code>apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: prometheus-oper-istio-dataplane
  labels:
    monitoring: istio-dataplane
spec:
  selector:
    matchExpressions:
      - {key: istio-prometheus-ignore, operator: DoesNotExist}
  namespaceSelector:
    any: true
  jobLabel: envoy-stats
  endpoints:
  - path: /stats/prometheus
    targetPort: http-envoy-prom
    interval: 15s


</code></pre>
<h2 id="æŸ¥çœ‹æ˜¯å¦ç”Ÿæ•ˆ">æŸ¥çœ‹æ˜¯å¦ç”Ÿæ•ˆ</h2>
<figure data-type="image" tabindex="1"><img src="https://oldcamel.run/post-images/1608882536864.png" alt="" loading="lazy"></figure>
<figure data-type="image" tabindex="2"><img src="https://oldcamel.run/post-images/1608882571184.png" alt="" loading="lazy"></figure>
<h2 id="victoriametrics-ä¸­ä¸åŒé›†ç¾¤ä¸­çš„æŒ‡æ ‡è·å–">VictoriaMetrics ä¸­ä¸åŒé›†ç¾¤ä¸­çš„æŒ‡æ ‡è·å–</h2>
<figure data-type="image" tabindex="3"><img src="https://oldcamel.run/post-images/1608882968056.png" alt="" loading="lazy"></figure>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[VictoriaMetrics æ±‡æ€»å¤šä¸ªPrometheusæŒ‡æ ‡ï¼ˆä¸‰ï¼‰kube-prometheuså®‰è£…]]></title>
        <id>https://oldcamel.run/post/victoriametrics-hui-zong-duo-ge-prometheus-zhi-biao-san-kube-prometheus-an-zhuang/</id>
        <link href="https://oldcamel.run/post/victoriametrics-hui-zong-duo-ge-prometheus-zhi-biao-san-kube-prometheus-an-zhuang/">
        </link>
        <updated>2020-12-25T07:32:20.000Z</updated>
        <content type="html"><![CDATA[<p>kube-prometheusæ˜¯Prometheus Operator é’ˆå¯¹kubernetesçš„ç›‘æ§ç»„ä»¶ã€‚<br>
githubåœ°å€<br>
<a href="https://github.com/prometheus-operator/kube-prometheus">https://github.com/prometheus-operator/kube-prometheus</a></p>
<h2 id="é…ç½®è¿œç¨‹å†™å…¥">é…ç½®è¿œç¨‹å†™å…¥</h2>
<h3 id="basicç”¨æˆ·åå¯†ç é…ç½®-secret">basicç”¨æˆ·åå¯†ç é…ç½® secret</h3>
<pre><code>apiVersion: v1
kind: Secret
metadata:
  name: vmuser
  namespace: monitoring
type: kubernetes.io/basic-auth
stringData:
  username: username
  password: password
</code></pre>
<h3 id="æ·»åŠ è¿œç¨‹å†™å…¥-å’Œå¤–éƒ¨æ ‡ç­¾">æ·»åŠ è¿œç¨‹å†™å…¥ å’Œå¤–éƒ¨æ ‡ç­¾</h3>
<p>ä¿®æ”¹prometheus-prometheus.yamlæ–‡ä»¶ï¼Œæ·»åŠ </p>
<pre><code>prometheusExternalLabelName: &quot;&quot;
  replicaExternalLabelName: &quot;&quot;
  externalLabels:
    tenant: &quot;ç§Ÿæˆ·åç§°&quot;
  remoteWrite:
    - url: http://VictoriaMetricsè¿æ¥åœ°å€/api/v1/write
      basicAuth:
       username:
          key: username
          name: vmuser
       password:
          key: password
          name: vmuser
</code></pre>
]]></content>
    </entry>
</feed>